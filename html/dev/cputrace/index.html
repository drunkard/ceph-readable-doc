

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>CpuTrace &mdash; Ceph Documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="CRUSH MSR (Multi-step Retry)" href="../crush-msr/" />
    <link rel="prev" title="Oprofile 的安装" href="../cpu-profiler/" /> 
</head>

<body class="wy-body-for-nav">

   
  <header class="top-bar">
    <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../internals/">Ceph 内幕</a></li>
      <li class="breadcrumb-item active">CpuTrace</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/dev/cputrace.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
  </header>
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #eee" >
          

          
            <a href="../../" class="icon icon-home"> Ceph
          

          
          </a>

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/">Ceph 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">安装 Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph 存储集群</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph 文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph 块设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph 对象网关</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph 管理器守护进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph 仪表盘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring/">监控概览</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">体系结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/">开发者指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../internals/">Ceph 内幕</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../balancer-design/">Ceph 如何均衡（读写、容量）</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blkin/">Tracing Ceph With LTTng</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blkin/#tracing-ceph-with-blkin">Tracing Ceph With Blkin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bluestore/">BlueStore Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ceph_krb_auth/">如何配置好 Ceph Kerberos 认证的详细文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cephfs-fscrypt/">CephFS Fscrypt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cephfs-mirroring/">CephFS Mirroring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cephfs-reclaim/">CephFS Reclaim Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cephfs-snapshots/">CephFS 快照</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cephx/">Cephx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cephx_protocol/">Cephx 认证协议详细阐述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config/">配置管理系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config-key/">config-key layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../context/">CephContext</a></li>
<li class="toctree-l2"><a class="reference internal" href="../continuous-integration/">Continuous Integration Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../corpus/">资料库结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cpu-profiler/">Oprofile 的安装</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">CpuTrace</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#integration-into-ceph">Integration into Ceph</a></li>
<li class="toctree-l3"><a class="reference internal" href="#raw-counter-mode">Raw counter mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#aggregating-samples">Aggregating samples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#measurement-t"><code class="docutils literal notranslate"><span class="pre">measurement_t</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#raii-samples">RAII samples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#named-measurements">Named measurements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#admin-socket-integration">Admin socket integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-reference">API Reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#enums">Enums</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-structures">Data structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#low-level-api">Low-level API</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../crush-msr/">CRUSH MSR (Multi-step Retry)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cxx/">C++17 and libstdc++ ABI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../deduplication/">去重</a></li>
<li class="toctree-l2"><a class="reference internal" href="../delayed-delete/">CephFS delayed deletion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev_cluster_deployment/">开发集群的部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dev_cluster_deployment/#id5">在同一机器上部署多套开发集群</a></li>
<li class="toctree-l2"><a class="reference internal" href="../development-workflow/">开发流程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../documenting/">为 Ceph 写作文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dpdk/">Ceph messenger DPDKStack</a></li>
<li class="toctree-l2"><a class="reference internal" href="../encoding/">序列化（编码、解码）</a></li>
<li class="toctree-l2"><a class="reference internal" href="../erasure-coded-pool/">纠删码存储池</a></li>
<li class="toctree-l2"><a class="reference internal" href="../file-striping/">File striping</a></li>
<li class="toctree-l2"><a class="reference internal" href="../freebsd/">FreeBSD Implementation details</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generatedocs/">Ceph 文档的构建</a></li>
<li class="toctree-l2"><a class="reference internal" href="../health-reports/">Health Reports</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iana/">IANA 号</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kclient/">Testing changes to the Linux Kernel CephFS driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kclient/#step-one-build-the-kernel">Step One: build the kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kclient/#step-two-create-a-vm">Step Two: create a VM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kclient/#step-three-networking-the-vm">Step Three: Networking the VM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kubernetes/">Hacking on Ceph in Kubernetes with Rook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libcephfs_proxy/">Design of the libcephfs proxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libs/">库体系结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/">集群日志的用法</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logs/">调试日志</a></li>
<li class="toctree-l2"><a class="reference internal" href="../macos/">在 MacOS 上构建</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mempool_accounting/">What is a mempool?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mempool_accounting/#some-common-mempools-that-we-can-track">Some common mempools that we can track</a></li>
<li class="toctree-l2"><a class="reference internal" href="../messenger/">Messenger notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mon-bootstrap/">Monitor bootstrap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mon-elections/">Monitor Elections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mon-on-disk-formats/">ON-DISK FORMAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mon-osdmap-prune/">FULL OSDMAP VERSION PRUNING</a></li>
<li class="toctree-l2"><a class="reference internal" href="../msgr2/">msgr2 协议（ msgr2.0 和 msgr2.1 ）</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network-encoding/">Network Encoding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network-protocol/">网络协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="../object-store/">对象存储架构概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="../osd-class-path/">OSD class path issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../peering/">互联</a></li>
<li class="toctree-l2"><a class="reference internal" href="../perf/">Using perf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../perf_counters/">性能计数器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../perf_histograms/">Perf histograms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../placement-group/">PG （归置组）说明</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pool-migration-design/">Design of Pool Migration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quick_guide/">开发者指南（快速）</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rados-client-protocol/">RADOS 客户端协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-diff/">RBD 增量备份</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-export/">RBD Export &amp; Import</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-layering/">RBD Layering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release-checklists/">Release checklists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release-process/">Ceph Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sepia/">Sepia 社区测试实验室</a></li>
<li class="toctree-l2"><a class="reference internal" href="../session_authentication/">Session Authentication for the Cephx Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/">测试笔记</a></li>
<li class="toctree-l2"><a class="reference internal" href="../versions/">Public OSD Version</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vstart-ganesha/">NFS CephFS-RGW Developer Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wireshark/">Wireshark Dissector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../zoned-storage/">Zoned Storage Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../osd_internals/">OSD 开发者文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mds_internals/">MDS 开发者文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../radosgw/">RADOS 网关开发者文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ceph-volume/">ceph-volume 开发者文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crimson/">Crimson developer documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">项目管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph 基金会</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crimson/crimson/">Crimson (Tech Preview)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/general/">Ceph 版本（总目录）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph 版本（索引）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware-monitoring/">硬件监控</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Ceph 术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jaegertracing/">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../translation_cn/">中文版翻译资源</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Ceph</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
<div id="dev-warning" class="admonition note">
  <p class="first admonition-title">Notice</p>
  <p class="last">This document is for a development version of Ceph.</p>
</div>
  <div id="docubetter" align="right" style="padding: 5px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="cputrace">
<h1>CpuTrace<a class="headerlink" href="#cputrace" title="Permalink to this heading"></a></h1>
<p>CpuTrace is a developer tool that measures the CPU cost of execution.
It is useful when deciding between algorithms for new code and for
validating performance enhancements.
CpuTrace measures CPU instructions, clock cycles, branch mispredictions,
cache misses and thread reschedules.</p>
<section id="integration-into-ceph">
<h2>Integration into Ceph<a class="headerlink" href="#integration-into-ceph" title="Permalink to this heading"></a></h2>
<p>To enable CpuTrace, build with the <code class="docutils literal notranslate"><span class="pre">WITH_CPUTRACE</span></code> flag:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./do_cmake.sh<span class="w"> </span>-DWITH_CPUTRACE<span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Once built with CpuTrace support, you can annotate specific functions
or code regions using the provided macros and helper classes.</p>
<p>To enable profiling in your code, include the CpuTrace header:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;common/cputrace.h&quot;</span>
</pre></div>
</div>
<p>Then you can mark functions for profiling using the provided helpers.</p>
</section>
<section id="raw-counter-mode">
<h2>Raw counter mode<a class="headerlink" href="#raw-counter-mode" title="Permalink to this heading"></a></h2>
<p>CpuTrace is using the Linux <code class="docutils literal notranslate"><span class="pre">perf_event_open</span></code> syscall. You can use the tool
as a simple helper to get access to hardware perf counters.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// I am profiling my code and want to know</span>
<span class="c1">// how many clock cycles and how many thread switches it takes</span>
<span class="n">HW_ctx</span><span class="w"> </span><span class="n">hw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HW_ctx_empty</span><span class="p">;</span>
<span class="n">HW_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="n">HW_PROFILE_SWI</span><span class="o">|</span><span class="n">HW_PROFILE_CYC</span><span class="p">);</span>
<span class="n">sample_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
<span class="n">HW_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
<span class="c1">// my code starts</span>
<span class="c1">// .....</span>
<span class="c1">// my code ends</span>
<span class="n">HW_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">end</span><span class="p">);</span>
<span class="c1">// task_switches = end.swi - start.swi;</span>
<span class="c1">// clock_cycles  = end.cyc - start.cyc;</span>
<span class="n">HW_clean</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="p">);</span>
</pre></div>
</div>
<p>By inspecting <code class="docutils literal notranslate"><span class="pre">task_switches</span></code> and <code class="docutils literal notranslate"><span class="pre">clock_cycles</span></code> the developer can learn that
real clock execution time of 10ms has only 1M clock cycles, but had 2 task switches.</p>
</section>
<section id="aggregating-samples">
<h2>Aggregating samples<a class="headerlink" href="#aggregating-samples" title="Permalink to this heading"></a></h2>
<p>A single readout of execution time is usually not enough. We need more samples
to get a more realistic measurement of actual execution cost.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// a variable to hold my measurement</span>
<span class="k">static</span><span class="w"> </span><span class="n">measurement_t</span><span class="w"> </span><span class="n">my_code_time</span><span class="p">;</span>
<span class="n">sample_t</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">elapsed</span><span class="p">;</span>
<span class="c1">// hw initialized somewhere else</span>
<span class="n">HW_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
<span class="c1">// my code starts</span>
<span class="c1">// .....</span>
<span class="c1">// my code ends</span>
<span class="n">HW_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">end</span><span class="p">);</span>
<span class="n">elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">;</span>
<span class="c1">// add new sample to the whole measurement</span>
<span class="n">my_code_time</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="n">elapsed</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="measurement-t">
<h2><code class="docutils literal notranslate"><span class="pre">measurement_t</span></code><a class="headerlink" href="#measurement-t" title="Permalink to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">measurement_t</span></code> type aggregates collected samples and counts the number
of measurements performed.</p>
<p>It produces summary statistics that include:</p>
<ul class="simple">
<li><p><strong>count</strong> : total number of measurements</p></li>
<li><p><strong>average</strong> : mean value across all samples</p></li>
<li><p><strong>zero / non-zero split</strong> : how many measurements were exactly zero
versus greater than zero (only for context switch metrics)</p></li>
</ul>
<p>These statistics provide a compact and clear view of performance measurements.</p>
<p><code class="docutils literal notranslate"><span class="pre">measurement_t</span></code> can also export results in two formats:</p>
<ul>
<li><p><strong>Ceph Formatter</strong> (for structured JSON/YAML/XML output):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span><span class="o">::</span><span class="n">Formatter</span><span class="o">*</span><span class="w"> </span><span class="n">jf</span><span class="p">;</span>
<span class="n">m</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">(</span><span class="n">jf</span><span class="p">,</span><span class="w"> </span><span class="n">HW_PROFILE_CYC</span><span class="o">|</span><span class="n">HW_PROFILE_INS</span><span class="p">);</span><span class="w"> </span><span class="c1">// Select which stats to output</span>
</pre></div>
</div>
</li>
<li><p><strong>String stream</strong> (for plain-text logging):</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">stringstream</span><span class="w"> </span><span class="n">ss</span><span class="p">;</span>
<span class="n">m</span><span class="o">-&gt;</span><span class="n">dump_to_stringstream</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">HW_PROFILE_CYC</span><span class="o">|</span><span class="n">HW_PROFILE_INS</span><span class="p">);</span><span class="w"> </span><span class="c1">// Select which stats to output</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
</pre></div>
</div>
</li>
</ul>
<p>This makes it easy to either integrate measurements into Ceph’s
structured output pipeline or dump them as human-readable text for debugging.</p>
</section>
<section id="raii-samples">
<h2>RAII samples<a class="headerlink" href="#raii-samples" title="Permalink to this heading"></a></h2>
<p>It is usually most convenient to use RAII to collect samples.
With RAII, measurement begins automatically when the guard object is created
and ends when it goes out of scope, so no explicit start/stop calls are required.</p>
<p>The hardware context (<code class="docutils literal notranslate"><span class="pre">HW_ctx</span></code>) must be initialized once before creating
guards. After initialization, the same context can be reused across multiple
measurements.</p>
<p><code class="docutils literal notranslate"><span class="pre">HW_guard</span></code> takes two arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">HW_ctx*</span> <span class="pre">ctx</span></code>
Pointer to the initialized hardware context.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">measurement_t*</span> <span class="pre">m</span></code>
Pointer to the measurement object where results will be stored.</p></li>
</ul>
<p>Example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// variable to hold measurement results</span>
<span class="k">static</span><span class="w"> </span><span class="n">measurement_t</span><span class="w"> </span><span class="n">my_code_time</span><span class="p">;</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">HW_guard</span><span class="w"> </span><span class="nf">guard</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">my_code_time</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// code to be measured</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="named-measurements">
<h2>Named measurements<a class="headerlink" href="#named-measurements" title="Permalink to this heading"></a></h2>
<p>Code regions can be measured using a <cite>named guard</cite>.
Each <code class="docutils literal notranslate"><span class="pre">HW_named_guard</span></code> automatically starts measurement at construction and stops when leaving scope.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="n">HW_named_guard</span><span class="p">(</span><span class="s">&quot;function&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hw</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// my code starts</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="w">  </span><span class="c1">// my code ends</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This example records the execution time of <code class="docutils literal notranslate"><span class="pre">function</span></code>.</p>
<p>The guard requires a pointer to a previously initialized <code class="docutils literal notranslate"><span class="pre">HW_ctx</span></code>.
This context must be created and set up (e.g., during program initialization)
before guards can be used.</p>
<p>Named guards provide a simple and consistent way to track performance metrics.</p>
<p>To later access the collected measurements for a given name, use:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">measurement_t</span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_named_measurement</span><span class="p">(</span><span class="s">&quot;function&quot;</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// inspect m-&gt;sum_cyc, m-&gt;sum_ins.</span>
<span class="w">  </span><span class="c1">// m-&gt;dump_to_stringstream(ss, HW_PROFILE_INS|HW_PROFILE_CYC);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="admin-socket-integration">
<h2>Admin socket integration<a class="headerlink" href="#admin-socket-integration" title="Permalink to this heading"></a></h2>
<p>In addition to direct instrumentation in code, CpuTrace can also be controlled
at runtime via the admin socket interface. This allows developers to start,
stop, and inspect profiling in running Ceph daemons without rebuilding or
restarting them.</p>
<p>To profile a function, annotate it with the provided macros:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">HWProfileFunctionF</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span><span class="w"> </span><span class="n">__func__</span><span class="p">,</span>
<span class="w">                   </span><span class="n">HW_PROFILE_CYC</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">HW_PROFILE_CMISS</span><span class="w"> </span><span class="o">|</span>
<span class="w">                   </span><span class="n">HW_PROFILE_INS</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">HW_PROFILE_BMISS</span><span class="w"> </span><span class="o">|</span>
<span class="w">                   </span><span class="n">HW_PROFILE_SWI</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">profile</span></code> is a local variable name for the profiler object and only needs to be unique within the profiling scope.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__func__</span></code> (or any string you pass as the name) is the unique anchor name for this profiling scope.</p></li>
</ul>
<p>Each unique name creates a separate anchor. Reusing the same name in multiple places will trigger an assertion failure.</p>
<p>This macro automatically attaches a profiler to the function scope and
collects the specified hardware counters each time the function executes.</p>
<p>You can combine any of the available flags:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">HW_PROFILE_CYC</span></code>   – CPU cycles</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HW_PROFILE_CMISS</span></code> – Cache misses</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HW_PROFILE_BMISS</span></code> – Branch mispredictions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HW_PROFILE_INS</span></code>   – Instructions retired</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HW_PROFILE_SWI</span></code>   – Context switches</p></li>
</ul>
<p>Available commands:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cputrace</span> <span class="pre">start</span></code> – Start profiling with the configured groups/counters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cputrace</span> <span class="pre">stop</span></code> – Stop profiling and freeze results</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cputrace</span> <span class="pre">dump</span></code> – Dump all collected metrics (as JSON or plain text)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cputrace</span> <span class="pre">reset</span></code> – Reset all captured data</p></li>
</ul>
<p>Profiling counters are cumulative. <cite>cputrace stop</cite> pauses profiling without
resetting values. <cite>cputrace start</cite> resumes accumulation. Use <cite>cputrace reset</cite>
to clear all collected metrics.</p>
<p>Example usage from the command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start profiling on OSD.0</span>
ceph<span class="w"> </span>tell<span class="w"> </span>osd.0<span class="w"> </span>cputrace<span class="w"> </span>start

<span class="c1"># Stop profiling</span>
ceph<span class="w"> </span>tell<span class="w"> </span>osd.0<span class="w"> </span>cputrace<span class="w"> </span>stop

<span class="c1"># Dump results</span>
ceph<span class="w"> </span>tell<span class="w"> </span>osd.0<span class="w"> </span>cputrace<span class="w"> </span>dump

<span class="c1"># Reset counters</span>
ceph<span class="w"> </span>tell<span class="w"> </span>osd.0<span class="w"> </span>cputrace<span class="w"> </span>reset
</pre></div>
</div>
<p>These commands can be repeated multiple times: developers typically
<code class="docutils literal notranslate"><span class="pre">start</span></code> before a workload, <code class="docutils literal notranslate"><span class="pre">stop</span></code> afterwards, and then <code class="docutils literal notranslate"><span class="pre">dump</span></code> the results
to analyze them.</p>
<p><code class="docutils literal notranslate"><span class="pre">cputrace</span> <span class="pre">dump</span></code> supports optional arguments to filter by logger or counter,
so only a subset of metrics can be reported when needed.</p>
<p><code class="docutils literal notranslate"><span class="pre">cputrace</span> <span class="pre">reset</span></code> clears all data, preparing for a fresh round of profiling.</p>
</section>
<section id="api-reference">
<h2>API Reference<a class="headerlink" href="#api-reference" title="Permalink to this heading"></a></h2>
<section id="enums">
<h3>Enums<a class="headerlink" href="#enums" title="Permalink to this heading"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="nc">cputrace_flags</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">HW_PROFILE_SWI</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="c1">// Context switches</span>
<span class="w">    </span><span class="n">HW_PROFILE_CYC</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="c1">// CPU cycles</span>
<span class="w">    </span><span class="n">HW_PROFILE_CMISS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="c1">// Cache misses</span>
<span class="w">    </span><span class="n">HW_PROFILE_BMISS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="c1">// Branch mispredictions</span>
<span class="w">    </span><span class="n">HW_PROFILE_INS</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1ULL</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="c1">// Instructions retired</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The bitwise <code class="docutils literal notranslate"><span class="pre">|</span></code> operator may be used to combine these flags.</p>
</section>
<section id="data-structures">
<h3>Data structures<a class="headerlink" href="#data-structures" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">sample_t</span></code> – holds a single hardware counter snapshot.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">sample_t</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">swi</span><span class="p">;</span><span class="w">   </span><span class="c1">//context switches</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">cyc</span><span class="p">;</span><span class="w">   </span><span class="c1">//clock cycles</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">cmiss</span><span class="p">;</span><span class="w"> </span><span class="c1">//cache misses</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">bmiss</span><span class="p">;</span><span class="w"> </span><span class="c1">//branch misses</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ins</span><span class="p">;</span><span class="w">   </span><span class="c1">//instructions</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">measurement_t</span></code> – accumulates multiple samples and computes totals/averages and other
useful metrics.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">measurement_t</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">call_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">sample_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">sum_swi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sum_cyc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sum_cmiss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sum_bmiss</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sum_ins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">non_zero_swi_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">zero_swi_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">HW_ctx</span></code> – encapsulates perf-event file descriptors for one measurement context.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">extern</span><span class="w"> </span><span class="n">HW_ctx</span><span class="w"> </span><span class="n">HW_ctx_empty</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="low-level-api">
<h3>Low-level API<a class="headerlink" href="#low-level-api" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">HW_init(HW_ctx*</span> <span class="pre">ctx,</span> <span class="pre">cputrace_flags</span> <span class="pre">flags)</span></code> – initialize perf counters.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">HW_read(HW_ctx*</span> <span class="pre">ctx,</span> <span class="pre">sample_t*</span> <span class="pre">out)</span></code> – read current counter values.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">HW_clean(HW_ctx*</span> <span class="pre">ctx)</span></code> – release perf counters.</p></li>
</ul>
</section>
</section>
</section>



<div id="support-the-ceph-foundation" class="admonition note">
  <p class="first admonition-title">Brought to you by the Ceph Foundation</p>
  <p class="last">The Ceph Documentation is a community resource funded and hosted by the non-profit <a href="https://ceph.io/en/foundation/">Ceph Foundation</a>. If you would like to support this and our other efforts, please consider <a href="https://ceph.io/en/foundation/join/">joining now</a>.</p>
</div>


           </div>
           
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../cpu-profiler/" class="btn btn-neutral float-left" title="Oprofile 的安装" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../crush-msr/" class="btn btn-neutral float-right" title="CRUSH MSR (Multi-step Retry)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).</p>
  </div>

   

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>