

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Fscrypt Encryption on CephFS &mdash; Ceph Documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Ceph 文件系统客户端的驱逐" href="../eviction/" />
    <link rel="prev" title="CephFS 快照" href="../snapshots/" /> 
</head>

<body class="wy-body-for-nav">

   
  <header class="top-bar">
    <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../">Ceph 文件系统</a></li>
      <li class="breadcrumb-item active">Fscrypt Encryption on CephFS</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/cephfs/fscrypt.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
  </header>
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #eee" >
          

          
            <a href="../../" class="icon icon-home"> Ceph
          

          
          </a>

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/">Ceph 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">安装 Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph 存储集群</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph 文件系统</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../#cephfs">CephFS 入门</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#id4">管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#id5">挂载 CephFS</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../#id6">CephFS 内幕</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../mds-states/"> MDS 的各种状态</a></li>
<li class="toctree-l3"><a class="reference internal" href="../posix/"> POSIX 兼容性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mds-journaling/"> MDS 日志记录</a></li>
<li class="toctree-l3"><a class="reference internal" href="../file-layouts/"> 文件布局</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mdcache/"> 分布式元数据缓存</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dynamic-metadata-management/"> CephFS 内的动态元数据管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cephfs-io-path/"> CephFS IO 路径</a></li>
<li class="toctree-l3"><a class="reference internal" href="../charmap/"> 大小写敏感和规范化</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lazyio/"> LazyIO</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dirfrags/"> 目录分片的配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../multimds/"> 多活 MDS 的配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../snapshots/"> 快照</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"> fscrypt</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#how-fscrypt-encryption-works">How Fscrypt Encryption Works</a></li>
<li class="toctree-l4"><a class="reference internal" href="#key-management">Key Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cephfs-support">CephFS Support</a></li>
<li class="toctree-l4"><a class="reference internal" href="#userspace-limitations">Userspace Limitations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-use">How to Use</a></li>
<li class="toctree-l4"><a class="reference internal" href="#behavior-of-master-key-in-snapshots-and-clones">Behavior of Master Key in Snapshots and Clones</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../#id7">故障排除和灾难恢复</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#id9">更多细节</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph 块设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph 对象网关</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph 管理器守护进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph 仪表盘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring/">监控概览</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">体系结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">开发者指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph 内幕</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">项目管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph 基金会</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crimson/crimson/">Crimson (Tech Preview)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/general/">Ceph 版本（总目录）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph 版本（索引）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware-monitoring/">硬件监控</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Ceph 术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jaegertracing/">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../translation_cn/">中文版翻译资源</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Ceph</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
<div id="dev-warning" class="admonition note">
  <p class="first admonition-title">Notice</p>
  <p class="last">This document is for a development version of Ceph.</p>
</div>
  <div id="docubetter" align="right" style="padding: 5px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="fscrypt-encryption-on-cephfs">
<span id="fscrypt"></span><h1>Fscrypt Encryption on CephFS<a class="headerlink" href="#fscrypt-encryption-on-cephfs" title="Permalink to this heading"></a></h1>
<p>Fscrypt is an encryption implementation at the file system level. This file
system encryption allows for encrypting on a per-directory level. This allows
for file systems to have encrypted and regular non-encrypted portions. Fscrypt
encryption encrypts file names and data contents.</p>
<section id="how-fscrypt-encryption-works">
<h2>How Fscrypt Encryption Works<a class="headerlink" href="#how-fscrypt-encryption-works" title="Permalink to this heading"></a></h2>
<section id="encryption-keys">
<h3>Encryption Keys<a class="headerlink" href="#encryption-keys" title="Permalink to this heading"></a></h3>
<p>Each fscrypt tree has a master encryption key. This master key will provide the
“secret” that is needed to encrypt directories. This key can be up to 256 bits
in length.</p>
</section>
<section id="policies">
<h3>Policies<a class="headerlink" href="#policies" title="Permalink to this heading"></a></h3>
<p>An fscrypt root is assigned to an encryption policy. This policy contains items such
as which encryption cipher to use and a master key id. This tells the client how
to encrypt/decrypt and to validate a given master key id to the encrypted inode.</p>
<p>Encryption happens completely on the client side. The MDS and OSD are not aware
of encryption policies or master keys. There has been minimal change to those
server components. They continue for the most part to store file names and data
contents (which in this case happen to be encrypted).</p>
</section>
<section id="access-semantics">
<h3>Access Semantics<a class="headerlink" href="#access-semantics" title="Permalink to this heading"></a></h3>
<p>There are semantics that allow different access depending on if the client has
the master key present for a directory or not.</p>
<p>With the key</p>
<ul class="simple">
<li><p>You can access the filesystem as you normally would.</p></li>
<li><p>You can see filenames, data contents and link targets.</p></li>
</ul>
<p>Without the key</p>
<ul class="simple">
<li><p>You do not see plaintext file names or link targets.</p></li>
<li><p>You cannot open a file.</p></li>
<li><p>You cannot access data contents in any form, not even the encrypted versions.</p></li>
<li><p>You cannot truncate a file.</p></li>
<li><p>You will see other metadata such as times, mode, ownership, and extended attributes.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You cannot backup or restore without the key.</p>
</div>
</section>
<section id="learning-by-example">
<h3>Learning by Example<a class="headerlink" href="#learning-by-example" title="Permalink to this heading"></a></h3>
<p>Consider a filesystem named <code class="docutils literal notranslate"><span class="pre">cephfs</span></code>. A client has two master keys and two
directories (<code class="docutils literal notranslate"><span class="pre">encdir1</span></code> and <code class="docutils literal notranslate"><span class="pre">encdira</span></code>). Each directory can have a different encryption
master key. For example, <code class="docutils literal notranslate"><span class="pre">encdir1</span></code> can have <code class="docutils literal notranslate"><span class="pre">key1</span></code> and then <code class="docutils literal notranslate"><span class="pre">encdira</span></code> can use <code class="docutils literal notranslate"><span class="pre">keyb</span></code>.
Then a regular directory (<code class="docutils literal notranslate"><span class="pre">regdir</span></code>) will also be present. Please note that <code class="docutils literal notranslate"><span class="pre">regdir</span></code> is an
unencrypted directory and shown for multi-tenant purposes. Figure 1 below
illustrates this.</p>
<p>When a policy is set on the directory, the directory must be empty. Then any subsequent
directories, files or links created in the subtree will inherit policy information
from its parent directory.</p>
<figure class="align-default" id="id1">
<img alt="../../_images/cephfs_fscrypt_overview.svg" src="../../_images/cephfs_fscrypt_overview.svg" /><figcaption>
<p><span class="caption-text">Figure 1</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
</section>
<section id="key-management">
<h2>Key Management<a class="headerlink" href="#key-management" title="Permalink to this heading"></a></h2>
<p>Each client has a unique view of the filesystem and the fscrypt tree. For this
example please refer to Figure 2 below. There are three clients, the first two
have a newer version of the CephFS client that includes the fscrypt feature
and the third does not. The key management of the keys are on a per-client basis.
What one client does pertaining to fscrypt the other is not aware of. Let’s take
a closer look to see the nuances in detail.</p>
<p>The first client, Client 1, has the master key present and is able to view the
encrypted tree transparently, this is the unlocked mode.</p>
<p>The second, Client 2, does not have the master key and does not have full
functionality, this is the locked mode. During locked mode, users cannot view
plaintext filenames or data contents. When a user lists the directory contents, it
will see a hashed version of the encrypted file name. Then when an <code class="docutils literal notranslate"><span class="pre">open()</span></code> occurs,
an error will be returned and operation will be denied. Things such as file
sizes, mode, timestamps and other inode metadata will be stored plaintext and
are available in this mode.</p>
<p>Finally, Client 3, is using an older version of CephFS client and does not have
fscrypt feature present. In this mode, users have the same view as before, but
are able to do some data operations to encrypted files. This mode is not
recommend and not supported.</p>
<figure class="align-default" id="id2">
<img alt="../../_images/cephfs_fscrypt_multiclient.svg" src="../../_images/cephfs_fscrypt_multiclient.svg" /><figcaption>
<p><span class="caption-text">Figure 2</span><a class="headerlink" href="#id2" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="cephfs-support">
<h2>CephFS Support<a class="headerlink" href="#cephfs-support" title="Permalink to this heading"></a></h2>
<p>There are two implementations of fscrypt within CephFS. It is supported in the
CephFS kernel client. This implementation extends capabilities that exist within
the kernel libraries and utilizes the kernel crypto keyring.</p>
<p>Secondly, the userspace client supports fscrypt within <code class="docutils literal notranslate"><span class="pre">ceph-fuse</span></code> and <code class="docutils literal notranslate"><span class="pre">libcephfs</span></code>.
Both of these versions are meant to be interoperable, but with some limitations.</p>
</section>
<section id="userspace-limitations">
<h2>Userspace Limitations<a class="headerlink" href="#userspace-limitations" title="Permalink to this heading"></a></h2>
<p>A custom fscrypt CLI will be needed to use userspace fscrypt. This is due to
permanent configurations in the kernel (which <code class="docutils literal notranslate"><span class="pre">ceph-fuse</span></code> utilizes) that are incorrectly
defined. Instead, there’s a fscrypt command line utility that is maintained
as a part of the Ceph project. This version includes necessary changes to configure
and use fscrypt.</p>
<p>This version is available at: <a class="reference external" href="https://github.com/ceph/fscrypt/tree/wip-ceph-fuse">https://github.com/ceph/fscrypt/tree/wip-ceph-fuse</a></p>
<p>Currently a subset of fscrypt ciphers are supported in user space.
They are:</p>
<ul class="simple">
<li><p>AES-256-XTS for contents</p></li>
<li><p>AES-256-CBC-CTS for filenames</p></li>
</ul>
<p>Any other ciphers used during setting a policy on a folder will be rejected.</p>
</section>
<section id="how-to-use">
<h2>How to Use<a class="headerlink" href="#how-to-use" title="Permalink to this heading"></a></h2>
<p>Setup system-wide encryption. This will initialize <code class="docutils literal notranslate"><span class="pre">/etc/fscrypt.conf</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "# ";
}
</style><span class="prompt1">fscrypt<span class="w"> </span>setup</span>
</pre></div></div><p>Setup mount-wide encryption. This has to be applied to the mount point for the
filesystem. This will setup internal fscrypt CLI config files for managing and
keeping track of encryption keys</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">fscrypt<span class="w"> </span>setup<span class="w"> </span>&lt;mount<span class="w"> </span>pt&gt;</span>
</pre></div></div><p>To setup a dir to be encrypted (it must be empty)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">fscrypt<span class="w"> </span>encrypt<span class="w"> </span>&lt;dir&gt;</span>
</pre></div></div><p>To lock an encrypted dir</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">fscrypt<span class="w"> </span>lock<span class="w"> </span>&lt;dir&gt;</span>
</pre></div></div><p>To unlock an encrypted dir</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">fscrypt<span class="w"> </span>unlock<span class="w"> </span>&lt;dir&gt;</span>
</pre></div></div><p>To view status of a directory (it can be a regular or encrypted dir)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">fscrypt<span class="w"> </span>status<span class="w"> </span>&lt;dir&gt;</span>
</pre></div></div></section>
<section id="behavior-of-master-key-in-snapshots-and-clones">
<h2>Behavior of Master Key in Snapshots and Clones<a class="headerlink" href="#behavior-of-master-key-in-snapshots-and-clones" title="Permalink to this heading"></a></h2>
<p>All snapshots and clones derived from an fscrypt directory will have their lock
state tied together. This means that all derived datasets will be locked or
unlocked at the same time.</p>
<p>For example, consider:</p>
<ol class="arabic simple">
<li><p>Encrypted <code class="docutils literal notranslate"><span class="pre">encdir1</span></code> is unlocked.</p></li>
<li><p>Snapshot of <code class="docutils literal notranslate"><span class="pre">encdir1</span></code> is created as <code class="docutils literal notranslate"><span class="pre">encdir1_snap</span></code>.</p></li>
<li><p>Clone of snapshot <code class="docutils literal notranslate"><span class="pre">encdir1_snap</span></code> is created as <code class="docutils literal notranslate"><span class="pre">encdir1_snap_clone1</span></code>.</p></li>
</ol>
<p>In this current state, <code class="docutils literal notranslate"><span class="pre">encdir1</span></code>, <code class="docutils literal notranslate"><span class="pre">encdir1_snap</span></code> and <code class="docutils literal notranslate"><span class="pre">encdir1_snap_clone1</span></code> are unlocked
and file names and data is accessible as expected in each state. If you perform a
lock on any of the three, all three will become locked.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Snapshot names are not encrypted.</p>
</div>
</section>
</section>



<div id="support-the-ceph-foundation" class="admonition note">
  <p class="first admonition-title">Brought to you by the Ceph Foundation</p>
  <p class="last">The Ceph Documentation is a community resource funded and hosted by the non-profit <a href="https://ceph.io/en/foundation/">Ceph Foundation</a>. If you would like to support this and our other efforts, please consider <a href="https://ceph.io/en/foundation/join/">joining now</a>.</p>
</div>


           </div>
           
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../snapshots/" class="btn btn-neutral float-left" title="CephFS 快照" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../eviction/" class="btn btn-neutral float-right" title="Ceph 文件系统客户端的驱逐" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).</p>
  </div>

   

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>