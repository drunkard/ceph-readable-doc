

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>故障排除 &mdash; Ceph Documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="灾难恢复" href="../disaster-recovery/" />
    <link rel="prev" title="高级话题：元数据修复工具" href="../disaster-recovery-experts/" /> 
</head>

<body class="wy-body-for-nav">

   
  <header class="top-bar">
    <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../">Ceph 文件系统</a></li>
      <li class="breadcrumb-item active">故障排除</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/cephfs/troubleshooting.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
  </header>
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #eee" >
          

          
            <a href="../../" class="icon icon-home"> Ceph
          

          
          </a>

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/">Ceph 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">安装 Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph 存储集群</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph 文件系统</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../#cephfs">CephFS 入门</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#id4">管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#id5">挂载 CephFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#id6">CephFS 内幕</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../#id7">故障排除和灾难恢复</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../eviction/"> 驱逐客户端</a></li>
<li class="toctree-l3"><a class="reference internal" href="../scrub/"> 洗刷</a></li>
<li class="toctree-l3"><a class="reference internal" href="../full/"> 文件系统占满的处理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../disaster-recovery-experts/"> 元数据修复</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"> 故障排除</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">慢或卡住的操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cephfs-dr-stuck-during-recovery">恢复期间卡住了</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">加快 MDS 日志修剪</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rados">RADOS 健康状况</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">MDS 问题</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ceph-fuse">ceph-fuse 的调试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kernel-mount-debugging">内核挂载的调试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">断线后又重新挂载的文件系统</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">挂载问题</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">动态调试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">转储内存中的日志</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">升级后无法访问文件系统</a></li>
<li class="toctree-l4"><a class="reference internal" href="#volumes">禁用 volumes 插件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">报告问题</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../disaster-recovery/"> 灾难恢复</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cephfs-journal-tool/"> cephfs-journal-tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../recover-fs-after-mon-store-loss/"> 监视器存储丢失后恢复文件系统</a></li>
<li class="toctree-l3"><a class="reference internal" href="../#id8">开发者指南</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../#id9">更多细节</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph 块设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph 对象网关</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph 管理器守护进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph 仪表盘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring/">监控概览</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">体系结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">开发者指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph 内幕</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">项目管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph 基金会</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crimson/crimson/">Crimson (Tech Preview)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/general/">Ceph 版本（总目录）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph 版本（索引）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware-monitoring/">硬件监控</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Ceph 术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jaegertracing/">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../translation_cn/">中文版翻译资源</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Ceph</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
<div id="dev-warning" class="admonition note">
  <p class="first admonition-title">Notice</p>
  <p class="last">This document is for a development version of Ceph.</p>
</div>
  <div id="docubetter" align="right" style="padding: 5px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="id1">
<h1>故障排除<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h1>
<section id="id2">
<h2>慢或卡住的操作<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h2>
<p>有时候 CephFS 的操作会卡住，解决这种问题首先要定位导致卡住的源头：
源头可能是这三个：</p>
<ol class="arabic simple">
<li><p>在客户端这边</p></li>
<li><p>MDS</p></li>
<li><p>连接客户端和 MDS 的网络。</p></li>
</ol>
<p>首先，按照 <a class="reference internal" href="#slow-requests"><span class="std std-ref">慢请求（ MDS ）</span></a> 里的步骤，检查客户端有没有卡住的操作、
或者 MDS 有没有卡住的操作。</p>
<p>转储（ dump ）出 MDS 的缓存。 MDS 缓存的内容将用于诊断问题的性质。
执行下列命令来转储 MDS 缓存：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "# ";
}
</style><span class="prompt1">ceph<span class="w"> </span>daemon<span class="w"> </span>mds.&lt;name&gt;<span class="w"> </span>dump<span class="w"> </span>cache<span class="w"> </span>/tmp/dump.txt</span>
</pre></div></div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>不受 systemd 控制的 MDS 服务会把文件
<code class="docutils literal notranslate"><span class="pre">dump.txt</span></code> 转储到运行 MDS 的机器上。
受 systemd 控制的 MDS 服务会把文件
<code class="docutils literal notranslate"><span class="pre">dump.txt</span></code> 转储到 MDS 容器中的 tmpfs 中。
用 <cite>nsenter(1)</cite> 查找 <code class="docutils literal notranslate"><span class="pre">dump.txt</span></code> 或指定另一个系统级的路径。</p>
</div>
<p>如果 MDS 设置了较高的日志级别，那么 <code class="docutils literal notranslate"><span class="pre">dump.txt</span></code> 差不多肯定有我们需要的信息，
能够诊断和解决导致 CephFS 操作卡住的问题。</p>
<section id="mds">
<span id="slow-requests"></span><h3>慢请求（ MDS ）<a class="headerlink" href="#mds" title="Permalink to this heading"></a></h3>
<p>用管理套接字罗列出当前的操作，在 MDS 主机上执行下列命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>daemon<span class="w"> </span>mds.&lt;name&gt;<span class="w"> </span>dump_ops_in_flight</span>
</pre></div></div><p>找到卡住的命令，并检查它们为何被卡住。
通常，最后一个 “event （事件）” 可能是尝试获取锁，
或者是正在将操作发送到 MDS 日志。如果它正在等待 OSD ，修复它们即可。</p>
<p>如果操作卡在某一个索引节点（ inode ）上，那么很可能是客户端持有某些能力，
耽搁了其他客户端使用该节点。
这种情况可能是由于客户端尝试刷回脏数据造成的，
也可能是由于您在 CephFS 的分布式文件锁代码（文件 “capabilities （能力）”， [“caps”] 系统）中遇到了缺陷。</p>
<p>如果您能确定那个命令是由于能力代码中的缺陷而卡住的，
重启 MDS 即可。重启那个 MDS 大概就能解决问题。</p>
<p>如果 MDS 上没有报告任何慢请求，并且没有迹象表明客户端行为异常，
那么要么是客户端本身存在问题，要么是客户端的请求无法到达 MDS 。</p>
</section>
</section>
<section id="cephfs-dr-stuck-during-recovery">
<span id="id3"></span><h2>恢复期间卡住了<a class="headerlink" href="#cephfs-dr-stuck-during-recovery" title="Permalink to this heading"></a></h2>
<section id="up-replay">
<h3>卡在 up:replay<a class="headerlink" href="#up-replay" title="Permalink to this heading"></a></h3>
<p>如果您的 MDS 卡在 <code class="docutils literal notranslate"><span class="pre">up:replay</span></code> 状态，说明日志可能很长。
<code class="docutils literal notranslate"><span class="pre">MDS_HEALTH_TRIM</span></code> 集群警告的存在就说明 MDS
尚未修剪完自己的日志，跟不上集群的当前状态。
如果日志过于长，可能需要数小时来处理。
虽然无法解决这个问题，但还是有办法加快速度的：</p>
<p>临时禁用 MDS 调试日志，把 MDS 调试级别降低到 <code class="docutils literal notranslate"><span class="pre">0</span></code> 。
即使在默认设置下， MDS 也会把一些信息记录到内存中，
以便在遇到致命错误时转储。
你可以关闭所有日志记录，执行下列命令：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mds<span class="w"> </span>debug_mds<span class="w"> </span><span class="m">0</span>
ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mds<span class="w"> </span>debug_ms<span class="w"> </span><span class="m">0</span>
ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mds<span class="w"> </span>debug_monc<span class="w"> </span><span class="m">0</span>
</pre></div>
</div>
<p>注意，你把 <code class="docutils literal notranslate"><span class="pre">debug_mds</span></code> 、 <code class="docutils literal notranslate"><span class="pre">debug_ms</span></code> 、和 <code class="docutils literal notranslate"><span class="pre">debug_monc</span></code>
设置成 <code class="docutils literal notranslate"><span class="pre">0</span></code> 之后，如果 MDS 发生故障，
则几乎没有任何调试信息用以确定致命错误发生的原因。
如果你能算出 <code class="docutils literal notranslate"><span class="pre">up:replay</span></code> 完成的时间，
应该在进入下一状态前恢复这些配置：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ceph<span class="w"> </span>config<span class="w"> </span>rm<span class="w"> </span>mds<span class="w"> </span>debug_mds
ceph<span class="w"> </span>config<span class="w"> </span>rm<span class="w"> </span>mds<span class="w"> </span>debug_ms
ceph<span class="w"> </span>config<span class="w"> </span>rm<span class="w"> </span>mds<span class="w"> </span>debug_monc
</pre></div>
</div>
<p>重放速度加快后，计算一下 MDS 的完成时间。
可以检查日志重放状态：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ceph<span class="w"> </span>tell<span class="w"> </span>mds.&lt;fs_name&gt;:0<span class="w"> </span>status<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>.replay_status
<span class="o">{</span>
<span class="w">  </span><span class="s2">&quot;journal_read_pos&quot;</span>:<span class="w"> </span><span class="m">4195244</span>,
<span class="w">  </span><span class="s2">&quot;journal_write_pos&quot;</span>:<span class="w"> </span><span class="m">4195244</span>,
<span class="w">  </span><span class="s2">&quot;journal_expire_pos&quot;</span>:<span class="w"> </span><span class="m">4194304</span>,
<span class="w">  </span><span class="s2">&quot;num_events&quot;</span>:<span class="w"> </span><span class="m">2</span>,
<span class="w">  </span><span class="s2">&quot;num_segments&quot;</span>:<span class="w"> </span><span class="m">2</span>
<span class="o">}</span>
</pre></div>
</div>
<p>当 <code class="docutils literal notranslate"><span class="pre">journal_read_pos</span></code> 追上 <code class="docutils literal notranslate"><span class="pre">journal_write_pos</span></code> 时，
重放就完成了。重放期间，写入位置不会改变。
跟踪读取位置的进展，就可以计算出预计完成的时间。
当日志重放操作耗时超过 30 秒时， MDS 会发一个 <cite>MDS_ESTIMATED_REPLAY_TIME</cite> 警告。
警告消息中包含日志重放的预计完成时间：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mds</span><span class="o">.</span><span class="n">a</span><span class="p">(</span><span class="n">mds</span><span class="mf">.0</span><span class="p">):</span> <span class="n">replay</span><span class="p">:</span> <span class="mf">50.0446</span><span class="o">%</span> <span class="n">complete</span> <span class="o">-</span> <span class="n">elapsed</span> <span class="n">time</span><span class="p">:</span> <span class="mi">582</span><span class="n">s</span><span class="p">,</span> <span class="n">estimated</span> <span class="n">time</span> <span class="n">remaining</span><span class="p">:</span> <span class="mi">581</span><span class="n">s</span>
</pre></div>
</div>
</section>
<section id="cephfs-troubleshooting-avoiding-recovery-roadblocks">
<span id="id4"></span><h3>避免恢复障碍<a class="headerlink" href="#cephfs-troubleshooting-avoiding-recovery-roadblocks" title="Permalink to this heading"></a></h3>
<p>在恢复文件系统时，需要做以下几件事：</p>
<ul>
<li><p><strong>拒绝所有到客户端的重连。</strong> 屏蔽所有现存的 CephFS 会话，
会导致所有挂载都将挂起或不可用。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mds<span class="w"> </span>mds_deny_all_reconnect<span class="w"> </span><span class="nb">true</span></span>
</pre></div></div><p>记着在所有 MDS 守护进程都活跃后撤销此操作。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>此操作不会阻止新会话连接。
想要那个效果的话，用文件系统的 <code class="docutils literal notranslate"><span class="pre">refuse_client_session</span></code> 配置选项。</p>
</div>
</li>
<li><p><strong>延长 MDS 心跳宽限期。</strong> 这样可以避免更换正在执行某些操作时看起来像 “卡死” 的 MDS 。
有时，一个 MDS 在恢复时的某个操作可能比预期的时间要长
（从程序员的角度来看）。当恢复所需的时间已经超过正常时间时，
就更有可能出现这种情况（要不您怎么会读本文档呢）。
通过延长心跳宽限期可以避免不必要的替换死循环，
执行下列命令：</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mds<span class="w"> </span>mds_heartbeat_grace<span class="w"> </span><span class="m">3600</span></span>
</pre></div></div></div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>这样做的效果是，即使 MDS 的内部 “心跳（ heartbeat ）” 机制在一小时内没有重置（跳动），它也会继续向监视器发送信标。
以前实现这一功能的机制是通过 <code class="docutils literal notranslate"><span class="pre">mds_beacon_grace</span></code> 监视器选项。</p>
</div>
</li>
<li><p><strong>禁用打开文件表（ open-file-table ）的预取功能。</strong> 通常，
MDS 会在恢复期间预取目录内容，以预热缓存。
在长时间恢复过程中，缓存可能已经很热<strong>而且很大</strong>。
如果缓存已经够热且巨大，这样的预取功能就没必要、
且与预期效果不相符。
执行下列命令禁用 open-file-table 预取功能：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mds<span class="w"> </span>mds_oft_prefetch_dirfrags<span class="w"> </span><span class="nb">false</span></span>
</pre></div></div></li>
<li><p><strong>关闭客户端。</strong> 客户端重新连接到刚刚变为 <code class="docutils literal notranslate"><span class="pre">up:active</span></code> 状态的 MDS 时，
可能会给刚恢复正常的文件系统带来新的负载。
通常需要一些维护，然后才能允许客户端连接到文件系统、并恢复到正常工作载荷。
例如，如果恢复时间过长是因为重放读取的日志过大，
那么加快日志的修剪可能是明智之举。</p>
<p>可以手动或用 <code class="docutils literal notranslate"><span class="pre">refuse_client_session</span></code> 可调选项拒绝客户端会话，
比如下面的例子：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>fs<span class="w"> </span><span class="nb">set</span><span class="w"> </span>&lt;fs_name&gt;<span class="w"> </span>refuse_client_session<span class="w"> </span><span class="nb">true</span></span>
</pre></div></div><p>此命令能防止客户端和 MDS
建立新会话。</p>
</li>
<li><p><strong>不要调整 max_mds</strong> 在故障排除或恢复过程中，
更改文件系统的配置变量 <code class="docutils literal notranslate"><span class="pre">max_mds</span></code> 看似是个好主意，
但实际上未必。
更改 <code class="docutils literal notranslate"><span class="pre">max_mds</span></code> 可能会进一步破坏集群的稳定性。
如果形势所迫，必须更改 <code class="docutils literal notranslate"><span class="pre">max_mds</span></code> ，应该执行命令更改 <code class="docutils literal notranslate"><span class="pre">max_mds</span></code> ，
还要加上确认标记（ <code class="docutils literal notranslate"><span class="pre">--yes-i-really-mean-it</span></code> ）。</p></li>
</ul>
<ul id="pause-purge-threads">
<li><p><strong>关闭异步清除线程</strong> volumes 插件会派生线程，
用于异步清除被销毁/删除的子卷。
在故障排除或恢复期间，可以禁用这些清除线程，
执行下列命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/volumes/pause_purging<span class="w"> </span><span class="nb">true</span></span>
</pre></div></div><p>恢复清除功能，执行下列命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/volumes/pause_purging<span class="w"> </span><span class="nb">false</span></span>
</pre></div></div></li>
</ul>
<ul id="pause-clone-threads">
<li><p><strong>关闭异步克隆线程</strong> volumes 插件会派生用于异步克隆子卷快照的线程。
在排除故障或恢复期间，可以禁用这些克隆线程，
执行下列命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/volumes/pause_cloning<span class="w"> </span><span class="nb">true</span></span>
</pre></div></div><p>恢复克隆功能，执行下列命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">config</span> <span class="nb">set</span> <span class="n">mgr</span> <span class="n">mgr</span><span class="o">/</span><span class="n">volumes</span><span class="o">/</span><span class="n">pause_cloning</span> <span class="n">false</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="id5">
<h2>加快 MDS 日志修剪<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">MDS_HEALTH_TRIM</span></code> 警告说明： MDS 日志已经过于大了。
当 MDS 日志积攒得太大后，可以用 <code class="docutils literal notranslate"><span class="pre">mds_tick_interval</span></code>
可调选项来更改 “MDS tick interval” （ MDS 计时间隔）。
tick 计时间隔驱动着 MDS 内部的各种维护活动，
修改这个计时间隔可降低 MDS 日志的尺寸，
因为它会导致日志更频繁地修剪。</p>
<p>建议在文件系统负载不太大的时候修改 <code class="docutils literal notranslate"><span class="pre">mds_tick_interval</span></code> 。
降低 CephFS 负载有多种方法，
见 <a class="reference internal" href="#cephfs-troubleshooting-avoiding-recovery-roadblocks"><span class="std std-ref">避免恢复障碍</span></a> 。</p>
<p>此配置只影响处于 <code class="docutils literal notranslate"><span class="pre">up:active</span></code> 状态的 MDS 。
恢复期间， MDS 不会修剪日志。</p>
<p>执行下列命令来修改 <code class="docutils literal notranslate"><span class="pre">mds_tick_interval</span></code> 可调选项：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mds<span class="w"> </span>mds_tick_interval<span class="w"> </span><span class="m">2</span></span>
</pre></div></div></section>
<section id="rados">
<h2>RADOS 健康状况<a class="headerlink" href="#rados" title="Permalink to this heading"></a></h2>
<p>如果只是 CephFS 的元数据或者数据存储池的某一部分不可用、
且 CephFS 不响应，很有可能是 RADOS 本身有问题。</p>
<p>应该先解决 RADOS 问题，然后再着手定位 CephFS 的问题。
见 <a class="reference internal" href="../../rados/troubleshooting/#rados-troubleshooting"><span class="std std-ref">RADOS 故障排除文档</span></a> 。</p>
</section>
<section id="id6">
<h2>MDS 问题<a class="headerlink" href="#id6" title="Permalink to this heading"></a></h2>
<p>执行 <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">health</span></code> 命令，如果某个操作卡在了 MDS 内部，
会出现 <code class="docutils literal notranslate"><span class="pre">slow</span> <span class="pre">requests</span> <span class="pre">are</span> <span class="pre">blocked</span></code> 消息。</p>
<p>消息是 <code class="docutils literal notranslate"><span class="pre">failing</span> <span class="pre">to</span> <span class="pre">respond</span></code> 的话，表明是客户端未能响应。</p>
<p>下面详细罗列了操作卡顿的潜在起因：</p>
<ol class="arabic">
<li><p>系统过载。导致系统过载最可能的起因是遇到了一个比 MDS 缓存还大的活跃文件集。</p>
<p>如果你还有空闲内存，增大 <code class="docutils literal notranslate"><span class="pre">mds_cache_memory_limit</span></code> 配置试试。
这个 <code class="docutils literal notranslate"><span class="pre">mds_cache_memory_limit</span></code> 可调选项在 <a class="reference internal" href="../cache-configuration/#cephfs-cache-configuration-mds-cache-memory-limit"><span class="std std-ref">MDS 缓存尺寸</span></a> 里详细论述了。
在对 <code class="docutils literal notranslate"><span class="pre">mds_cache_memory_limit</span></code> 做任何调整前，先完整地阅读一下
<a class="reference internal" href="../cache-configuration/#cephfs-mds-cache-configuration"><span class="std std-ref">MDS 缓存配置</span></a> 这一段。</p>
</li>
<li><p>有个老旧的（行为乖张）客户端；</p></li>
<li><p>底层的 RADOS 问题。见
<a class="reference internal" href="../../rados/troubleshooting/#rados-troubleshooting"><span class="std std-ref">RADOS 故障排除文档</span></a> 。</p></li>
</ol>
<p>除此之外，你也许遇到了新的软件缺陷，应该报告给开发者！</p>
</section>
<section id="ceph-fuse">
<span id="ceph-fuse-debugging"></span><h2>ceph-fuse 的调试<a class="headerlink" href="#ceph-fuse" title="Permalink to this heading"></a></h2>
<p>ceph-fuse 是 CephFS 内核驱动的一个替代，它在用户空间挂载 CephFS 文件系统。
ceph-fuse 也支持 <code class="docutils literal notranslate"><span class="pre">dump_ops_in_flight</span></code> 功能。
执行下列命令来转储出正在进行的 ceph-fuse 操作，以便检查：</p>
<p>见文档 <a class="reference internal" href="../mount-using-fuse/#cephfs-mount-using-fuse"><span class="std std-ref">用 FUSE 挂载 CephFS</span></a> 。</p>
<section id="id7">
<h3>调试输出<a class="headerlink" href="#id7" title="Permalink to this heading"></a></h3>
<p>要想看到 ceph-fuse 的更多调试信息，试试在前台运行，让日志输出到控制台（ <code class="docutils literal notranslate"><span class="pre">-d</span></code> ）、打开客户端调试（ <code class="docutils literal notranslate"><span class="pre">--debug-client=20</span></code> ）、即时打印发送过的每条消息（ <code class="docutils literal notranslate"><span class="pre">--debug-ms=1</span></code> ）。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>daemon<span class="w"> </span>-d<span class="w"> </span>mds.&lt;name&gt;<span class="w"> </span>dump_ops_in_flight<span class="w"> </span>--debug-client<span class="o">=</span><span class="m">20</span><span class="w"> </span>--debug-ms<span class="o">=</span><span class="m">1</span></span>
</pre></div></div><p>如果你怀疑是监视器的问题，也可以打开监视器调试开关（ <code class="docutils literal notranslate"><span class="pre">--debug-monc=20</span></code> ），
执行下列命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>daemon<span class="w"> </span>-d<span class="w"> </span>mds.&lt;name&gt;<span class="w"> </span>dump_ops_in_flight<span class="w"> </span>--debug-client<span class="o">=</span><span class="m">20</span><span class="w"> </span>--debug-ms<span class="o">=</span><span class="m">1</span><span class="w"> </span>--debug-monc<span class="o">=</span><span class="m">20</span></span>
</pre></div></div></section>
</section>
<section id="kernel-mount-debugging">
<span id="id8"></span><h2>内核挂载的调试<a class="headerlink" href="#kernel-mount-debugging" title="Permalink to this heading"></a></h2>
<p>如果内核客户端有问题，诊断并修复的第一步是找出问题起因，是在内核客户端上、
还是在 MDS 上。如果内核客户端自身出现故障，其故障证据位于内核环形缓冲区里，
可以执行下列命令来检查：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">dmesg</span>
</pre></div></div><p>找到相关的内核状态。</p>
<section id="id9">
<h3>慢请求<a class="headerlink" href="#id9" title="Permalink to this heading"></a></h3>
<p>遗憾的是，内核客户端不支持管理套接字。可是如果你客户端的内核启用了 <a class="reference external" href="https://docs.kernel.org/filesystems/debugfs.html">debugfs</a> ，
那么它就有相似管理套接字的接口了。</p>
<p>找到 <code class="docutils literal notranslate"><span class="pre">sys/kernel/debug/ceph/</span></code> 路径下的一个文件夹，其名字形如
<code class="docutils literal notranslate"><span class="pre">28f7427e-5558-4ffd-ae1a-51ec3042759a.client25386880</span></code> 。
这个文件夹下的文件可以用于诊断慢请求的起因，用 <code class="docutils literal notranslate"><span class="pre">cat</span></code> 命令查看它们的内容。</p>
<p>这些文件描述如下，最有助于诊断慢请求问题的文件是 <code class="docutils literal notranslate"><span class="pre">mdsc</span></code> （ MDS 的当前请求）和
<code class="docutils literal notranslate"><span class="pre">osdc</span></code> （当前正在对 OSD 进行的操作）。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bdi</span></code>: 关于 Ceph 系统的 BDI 信息（脏块、已写入的等等）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">caps</span></code>: 文件的 caps 数据结构计数，包括内存中的和用过的</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">client_options</span></code>: 转储挂载 CephFS 时所用的选项</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dentry_lru</span></code>: 转储当前内存中的 CephFS dentry</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mdsc</span></code>: 转储当前发给 MDS 的请求</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mdsmap</span></code>: 转储当前的 MDSMap 时间结和所有 MDS</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mds_sessions</span></code>: 转储当前与 MDS 建立的会话</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">monc</span></code>: 转储当前从监视器获取的各种映射图，以及其它“订阅”信息</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">monmap</span></code>: 转储当前的监视器图和所有监视器</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">osdc</span></code>: 转储当前发往 OSD 的操作（即文件数据的 IO ）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">osdmap</span></code>: 转储当前的 OSDMap 时间结、存储池、所有 OSD</p></li>
</ul>
<p>如果数据存储池处于 <code class="docutils literal notranslate"><span class="pre">NEARFULL</span></code> 状态，那么内核 CephFS 客户端将会切换到同步写，同步写操作非常慢。</p>
</section>
</section>
<section id="id10">
<h2>断线后又重新挂载的文件系统<a class="headerlink" href="#id10" title="Permalink to this heading"></a></h2>
<p>因为 CephFS 有个“一致性缓存 (consistent cache)”，
如果客户端的网络连接中断时间较长， MDS 就会强制驱逐（并加进黑名单）客户端。
此时，内核客户端不能安全地写回脏数据（缓冲的），而且这样会导致数据丢失。
然而：注意一下，这种行为也是合理的、且遵循 POSIX 语义。
这个客户端必须重新挂载才能再次访问那个文件系统，这是默认行为，
但可以用 <code class="docutils literal notranslate"><span class="pre">recover_session</span></code> 挂载选项覆盖。见 <a class="reference external" href="https://docs.ceph.com/en/latest/man/8/mount.ceph/#options">mount.ceph 手册页的 options 段落</a> 。</p>
<p>如果 <code class="docutils literal notranslate"><span class="pre">dmesg</span></code> 里出现了类似消息，说明你遇到的就是这种情况：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Fri</span> <span class="n">Aug</span> <span class="mi">15</span> <span class="mi">02</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">10</span> <span class="mi">2025</span><span class="p">]</span> <span class="n">ceph</span><span class="p">:</span> <span class="n">mds0</span> <span class="n">caps</span> <span class="n">stale</span>
<span class="p">[</span><span class="n">Fri</span> <span class="n">Aug</span> <span class="mi">15</span> <span class="mi">02</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">28</span> <span class="mi">2025</span><span class="p">]</span> <span class="n">libceph</span><span class="p">:</span> <span class="n">mds0</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="n">XXX</span><span class="o">.</span><span class="n">XX</span><span class="o">.</span><span class="n">XX</span><span class="o">.</span><span class="n">XX</span> <span class="p">:</span><span class="mi">6800</span> <span class="n">socket</span> <span class="n">closed</span> <span class="p">(</span><span class="n">con</span> <span class="n">state</span> <span class="n">OPEN</span><span class="p">)</span>
<span class="p">[</span><span class="n">Fri</span> <span class="n">Aug</span> <span class="mi">15</span> <span class="mi">02</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">28</span> <span class="mi">2025</span><span class="p">]</span> <span class="n">libceph</span><span class="p">:</span> <span class="n">mds0</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="n">XXX</span><span class="o">.</span><span class="n">XX</span><span class="o">.</span><span class="n">XX</span><span class="o">.</span><span class="n">XX</span><span class="p">:</span><span class="mi">6800</span> <span class="n">session</span> <span class="n">reset</span>
<span class="p">[</span><span class="n">Fri</span> <span class="n">Aug</span> <span class="mi">15</span> <span class="mi">02</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">28</span> <span class="mi">2025</span><span class="p">]</span> <span class="n">ceph</span><span class="p">:</span> <span class="n">mds0</span> <span class="n">closed</span> <span class="n">our</span> <span class="n">session</span>
<span class="p">[</span><span class="n">Fri</span> <span class="n">Aug</span> <span class="mi">15</span> <span class="mi">02</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">28</span> <span class="mi">2025</span><span class="p">]</span> <span class="n">ceph</span><span class="p">:</span> <span class="n">mds0</span> <span class="n">reconnect</span> <span class="n">start</span>
<span class="p">[</span><span class="n">Fri</span> <span class="n">Aug</span> <span class="mi">15</span> <span class="mi">02</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">28</span> <span class="mi">2025</span><span class="p">]</span> <span class="n">ceph</span><span class="p">:</span> <span class="n">mds0</span> <span class="n">reconnect</span> <span class="n">denied</span>
</pre></div>
</div>
</section>
<section id="id11">
<h2>挂载问题<a class="headerlink" href="#id11" title="Permalink to this heading"></a></h2>
<section id="id12">
<h3>挂载错误 5<a class="headerlink" href="#id12" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">5</span></code> 错误通常是 MDS 服务器滞后或崩溃导致的。</p>
<p>要确保至少有一个 MDS 是启动且在运行，集群也要处于 <code class="docutils literal notranslate"><span class="pre">active+healthy</span></code> 状态。</p>
</section>
<section id="id13">
<h3>挂载错误 12<a class="headerlink" href="#id13" title="Permalink to this heading"></a></h3>
<p>mount 12 错误显示 <code class="docutils literal notranslate"><span class="pre">cannot</span> <span class="pre">allocate</span> <span class="pre">memory</span></code> ，说明 <a class="reference internal" href="../../glossary/#term-4"><span class="xref std std-term">Ceph 客户端</span></a>和
<a class="reference internal" href="../../glossary/#term-28"><span class="xref std std-term">Ceph 存储集群</span></a>版本不匹配。用以下命令检查版本：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>-v</span>
</pre></div></div><p>如果 Ceph 客户端版本落后于集群，升级它：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">sudo<span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>ceph-common</span>
</pre></div></div><p>如果这样没能解决问题，那就 uninstall 、 autoclean 、再 autoremove 掉
<code class="docutils literal notranslate"><span class="pre">ceph-common</span></code> 软件包，然后再重新安装，以确保安装的是最新版。</p>
</section>
</section>
<section id="id14">
<h2>动态调试<a class="headerlink" href="#id14" title="Permalink to this heading"></a></h2>
<p>CephFS 内核驱动程序的动态调试功能允许启用或禁用调试日志记录。
内核驱动程序的日志会写入内核环形缓冲区，并且可以用 <code class="docutils literal notranslate"><span class="pre">dmesg(1)</span></code> 工具查看。
默认情况下，调试日志记录是禁用的，因为启用调试日志记录可能会导致系统运行缓慢和 I/O 吞吐量下降。</p>
<p>对 CephFS 模块开启动态调试。</p>
<p>请看： <a class="reference external" href="https://github.com/ceph/ceph/blob/master/src/script/kcon_all.sh">https://github.com/ceph/ceph/blob/master/src/script/kcon_all.sh</a></p>
<p>注意：运行上述脚本可启用 CephFS 内核驱动、 libceph 和内核 RBD 模块的调试日志记录。如果要打开指定组件
（例如， CephFS 内核驱动）的调试日志记录，执行下列命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1"><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;module ceph +p&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/dynamic_debug/control</span>
</pre></div></div><p>要禁用调试日志记录，执行下列命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1"><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;module ceph -p&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/dynamic_debug/control</span>
</pre></div></div></section>
<section id="id15">
<h2>转储内存中的日志<a class="headerlink" href="#id15" title="Permalink to this heading"></a></h2>
<p>日志级别设置得低于 <code class="docutils literal notranslate"><span class="pre">10</span></code> 时，可以设置
<code class="docutils literal notranslate"><span class="pre">mds_extraordinary_events_dump_interval</span></code> 来转储内存日志。
<code class="docutils literal notranslate"><span class="pre">mds_extraordinary_events_dump_interval</span></code> 是指发生异常事件时，
转储最近内存日志的时间间隔，以秒为单位。</p>
<p>异常事件包括：</p>
<ul class="simple">
<li><p>客户端驱逐</p></li>
<li><p>未收到监视器发来的信标 ACK</p></li>
<li><p>内部心跳未收到</p></li>
</ul>
<p>内存日志转储（ In-memory Log Dump ）默认是禁用的，以防生产环境中日志文件膨胀。</p>
<p>执行下列两个命令来启用内存日志转储：</p>
<ol class="arabic">
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mds<span class="w"> </span>debug_mds<span class="w"> </span>&lt;log_level&gt;/&lt;gather_level&gt;</span>
</pre></div></div><p><code class="docutils literal notranslate"><span class="pre">log_level</span></code> 要设置得低于 <code class="docutils literal notranslate"><span class="pre">10</span></code> 。把 <code class="docutils literal notranslate"><span class="pre">gather_level</span></code> 设置得大于 <code class="docutils literal notranslate"><span class="pre">10</span></code> 。
这两个值设置好后，就启用了内存日志转储。</p>
</li>
<li><div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mds<span class="w"> </span>mds_extraordinary_events_dump_interval<span class="w"> </span>&lt;seconds&gt;</span>
</pre></div></div><p>启用后， MDS 会每隔 <code class="docutils literal notranslate"><span class="pre">mds_extraordinary_events_dump_interval</span></code> 秒检查一次异常事件。如果有异常事件发生，
MDS 会把包含着相关事件细节的内存日志转储到 Ceph MDS 日志中。</p>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>设置了较高的日志级别（ <code class="docutils literal notranslate"><span class="pre">log_level</span></code> &gt;= <code class="docutils literal notranslate"><span class="pre">10</span></code> ）后，
就没必要转储内存日志。较低的收集级别（ <code class="docutils literal notranslate"><span class="pre">gather_level</span></code> &lt; <code class="docutils literal notranslate"><span class="pre">10</span></code> ）
不足以收集内存日志。也就是说，在 <code class="docutils literal notranslate"><span class="pre">debug_mds</span></code> 中，
日志级别大于等于 <code class="docutils literal notranslate"><span class="pre">10</span></code> 或收集级别小于 <code class="docutils literal notranslate"><span class="pre">10</span></code> 的时候就无法启用内存日志转储。
在这种情况下，出现故障时，必须把 <code class="docutils literal notranslate"><span class="pre">mds_extraordinary_events_dump_interval</span></code>
的值重置为 <code class="docutils literal notranslate"><span class="pre">0</span></code> ，然后再用上述命令启用。</p>
</div>
<p>禁用内存日志转储可以执行下列命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mds<span class="w"> </span>mds_extraordinary_events_dump_interval<span class="w"> </span><span class="m">0</span></span>
</pre></div></div></section>
<section id="id16">
<h2>升级后无法访问文件系统<a class="headerlink" href="#id16" title="Permalink to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在升级前运行此程序，可以避免出现 <code class="docutils literal notranslate"><span class="pre">operation</span> <span class="pre">not</span> <span class="pre">permitted</span></code>
（不允许操作）的错误。截至 2023 年 5 月，
Nautilus （含）之后的升级似乎会出现这里讨论的那种
<code class="docutils literal notranslate"><span class="pre">operation</span> <span class="pre">not</span> <span class="pre">permitted</span></code> 错误。</p>
</div>
<p><strong>如果</strong></p>
<p>您的 CephFS 文件系统中的数据存储池和元数据存储池是用
<code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">fs</span> <span class="pre">new</span></code> 命令创建的
（这意味着它们不是用默认值创建的）。</p>
<p><strong>或者</strong></p>
<p>您已经有一个 CephFS 文件系统，并且正在升级到新的、
高于 Nautilus 的 Ceph 主版本</p>
<p><strong>那么</strong></p>
<p>为了使文档中的 <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">fs</span> <span class="pre">authorize...</span></code> 命令按文档所述的行为运行
（并避免除 <code class="docutils literal notranslate"><span class="pre">client.admin</span></code> 用户外的所有用户们在做文件 I/O 时出现
‘operation not permitted’ 错误、或类似的安全相关问题），
您必须首先运行：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt2:before {
  content: "$ ";
}
</style><span class="prompt2">ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span>application<span class="w"> </span><span class="nb">set</span><span class="w"> </span>&lt;your<span class="w"> </span>metadata<span class="w"> </span>pool<span class="w"> </span>name&gt;<span class="w"> </span>cephfs<span class="w"> </span>metadata<span class="w"> </span>&lt;your<span class="w"> </span>ceph<span class="w"> </span>fs<span class="w"> </span>filesystem<span class="w"> </span>name&gt;</span>
</pre></div></div><p>和</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt2">ceph<span class="w"> </span>osd<span class="w"> </span>pool<span class="w"> </span>application<span class="w"> </span><span class="nb">set</span><span class="w"> </span>&lt;your<span class="w"> </span>data<span class="w"> </span>pool<span class="w"> </span>name&gt;<span class="w"> </span>cephfs<span class="w"> </span>data<span class="w"> </span>&lt;your<span class="w"> </span>ceph<span class="w"> </span>fs<span class="w"> </span>filesystem<span class="w"> </span>name&gt;</span>
</pre></div></div><p>否则，当 OSD 收到读取或写入数据
（不是目录信息，而是文件数据）的请求时，
它们将不知道要查找哪个 Ceph 文件系统名字。
存储池名字也是如此，因为主版本的“默认值”本身发生了变化，从:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="n">pool</span><span class="o">=</span><span class="n">fsname</span>
<span class="n">metadata</span> <span class="n">pool</span><span class="o">=</span><span class="n">fsname_metadata</span>
</pre></div>
</div>
<p>变成了：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="n">pool</span><span class="o">=</span><span class="n">fsname</span><span class="o">.</span><span class="n">data</span> <span class="ow">and</span>
<span class="n">metadata</span> <span class="n">pool</span><span class="o">=</span><span class="n">fsname</span><span class="o">.</span><span class="n">meta</span>
</pre></div>
</div>
<p>所有用 <code class="docutils literal notranslate"><span class="pre">client.admin</span></code> 进行挂载的都不会遇到这个问题，
因为 admin 密钥赋予了全部权限。</p>
<p>临时解决办法是把挂载请求改为 ‘client.admin’ 用户及其密钥。
另一个不那么彻底但也能凑合的办法是把用户的 osd cap 改为
<code class="docutils literal notranslate"><span class="pre">caps</span> <span class="pre">osd</span> <span class="pre">=</span> <span class="pre">&quot;allow</span> <span class="pre">rw&quot;</span></code> ，然后删除 <code class="docutils literal notranslate"><span class="pre">tag</span> <span class="pre">cephfs</span> <span class="pre">data=....</span></code> 。</p>
</section>
<section id="volumes">
<h2>禁用 volumes 插件<a class="headerlink" href="#volumes" title="Permalink to this heading"></a></h2>
<p>在某些情况下，可能需要禁用 Volumes 插件，以防止影响 Ceph 集群的其他部分。
详情见 <a class="reference internal" href="../fs-volumes/#disabling-volumes-plugin"><span class="std std-ref">禁用 volumes 插件</span></a> 。</p>
</section>
<section id="id17">
<h2>报告问题<a class="headerlink" href="#id17" title="Permalink to this heading"></a></h2>
<p>如果你确信发现了问题，报告时请附带尽可能多的信息，特别是重要信息：</p>
<ul class="simple">
<li><p>客户端和服务器所安装的 Ceph 版本；</p></li>
<li><p>你在用内核、还是用户空间客户端；</p></li>
<li><p>如果你在用内核客户端，是什么版本？</p></li>
<li><p>有多少个客户端在用？什么样的负载？</p></li>
<li><p>如果某个系统“卡住”了，它影响所有客户端呢还是只影响一个？</p></li>
<li><p>关于 Ceph 的健康状况消息；</p></li>
<li><p>崩溃时写入日志的回调栈。</p></li>
</ul>
<p>如果你觉得自己发现了一个缺陷，请在<a class="reference external" href="http://tracker.ceph.com">缺陷追踪器</a>提交。一般问题的话可以发邮件到 <a class="reference external" href="http://lists.ceph.com/listinfo.cgi/ceph-users-ceph.com/">ceph-users 邮件列表</a>询问。</p>
</section>
</section>



<div id="support-the-ceph-foundation" class="admonition note">
  <p class="first admonition-title">Brought to you by the Ceph Foundation</p>
  <p class="last">The Ceph Documentation is a community resource funded and hosted by the non-profit <a href="https://ceph.io/en/foundation/">Ceph Foundation</a>. If you would like to support this and our other efforts, please consider <a href="https://ceph.io/en/foundation/join/">joining now</a>.</p>
</div>


           </div>
           
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../disaster-recovery-experts/" class="btn btn-neutral float-left" title="高级话题：元数据修复工具" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../disaster-recovery/" class="btn btn-neutral float-right" title="灾难恢复" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).</p>
  </div>

   

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>