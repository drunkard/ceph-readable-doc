

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Bucket Logging &mdash; Ceph Documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Full RGW Object Dedup" href="../s3_objects_dedup/" />
    <link rel="prev" title="UADK Acceleration for Compression" href="../uadk-accel/" /> 
</head>

<body class="wy-body-for-nav">

   
  <header class="top-bar">
    <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../">Ceph 对象网关</a></li>
      <li class="breadcrumb-item active">Bucket Logging</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/radosgw/bucket_logging.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
  </header>
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #eee" >
          

          
            <a href="../../" class="icon icon-home"> Ceph
          

          
          </a>

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/">Ceph 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">安装 Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph 存储集群</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph 文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph 块设备</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph 对象网关</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../frontends/">HTTP 前端</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multisite/">多站配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../zone-features/">域的功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../placement/">存储池归置与存储类</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multisite-sync-policy/">多站同步策略配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pools/">存储池的配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config-ref/">配置参考</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin/">管理指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../account/">用户账户</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s3/">S3 API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iam/">IAM API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rgw-cache/">数据缓存和 CDN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../swift/">Swift API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../adminops/">管理操作 API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/">Python 接口</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nfs/">通过 NFS 导出</a></li>
<li class="toctree-l2"><a class="reference internal" href="../keystone/">与 OpenStack Keystone 对接</a></li>
<li class="toctree-l2"><a class="reference internal" href="../barbican/">与 OpenStack Barbican 对接</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vault/">与 HashiCorp Vault 对接</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kmip/">与 KMIP 对接</a></li>
<li class="toctree-l2"><a class="reference internal" href="../opa/">与 Open Policy Agent 对接</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multitenancy/">多租户</a></li>
<li class="toctree-l2"><a class="reference internal" href="../compression/">压缩</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ldap-auth/">LDAP 认证</a></li>
<li class="toctree-l2"><a class="reference internal" href="../encryption/">服务器端加密</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bucketpolicy/">桶策略</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dynamicresharding/">动态的桶索引重分片</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mfa/">多因子认证</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sync-modules/">同步模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notifications/">Bucket Notifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/">RADOS 中的数据布局</a></li>
<li class="toctree-l2"><a class="reference internal" href="../STS/">STS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../STSLite/">STS Lite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../keycloak/">Keycloak</a></li>
<li class="toctree-l2"><a class="reference internal" href="../session-tags/">Session Tags</a></li>
<li class="toctree-l2"><a class="reference internal" href="../role/">Role</a></li>
<li class="toctree-l2"><a class="reference internal" href="../orphans/">Orphan List and Associated Tooliing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oidc/">OpenID Connect Provider</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/">故障排除</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/radosgw/">radosgw 手册页</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/radosgw-admin/">radosgw-admin 手册页</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qat-accel/">使用 QAT 为加密和压缩提速</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s3select/">S3-select</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lua-scripting/">Lua Scripting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../d3n_datacache/">D3N Data Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud-transition/">Cloud Transition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cloud-restore/">Cloud Restore</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metrics/">Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../uadk-accel/">UADK Acceleration for Compression</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">桶的日志记录</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#logging-reliability">Logging Reliability</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#standard">Standard</a></li>
<li class="toctree-l4"><a class="reference internal" href="#journal">Journal</a></li>
<li class="toctree-l4"><a class="reference internal" href="#multisite">Multisite</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#bucket-logging-policy">Bucket Logging Policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bucket-logging-quota">Bucket Logging Quota</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bucket-logging-rest-api">Bucket Logging REST API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#log-objects-key-format">Log Objects Key Format</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#simple">Simple</a></li>
<li class="toctree-l4"><a class="reference internal" href="#partitioned">Partitioned</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#log-records-format">Log Records Format</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Journal</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Standard</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../s3_objects_dedup/">全文对象去重</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph 管理器守护进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph 仪表盘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring/">监控概览</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">体系结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">开发者指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph 内幕</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">项目管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph 基金会</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crimson/crimson/">Crimson (Tech Preview)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/general/">Ceph 版本（总目录）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/">Ceph 版本（索引）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware-monitoring/">硬件监控</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Ceph 术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jaegertracing/">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../translation_cn/">中文版翻译资源</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Ceph</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
<div id="dev-warning" class="admonition note">
  <p class="first admonition-title">Notice</p>
  <p class="last">This document is for a development version of Ceph.</p>
</div>
  <div id="docubetter" align="right" style="padding: 5px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="bucket-logging">
<h1><a class="toc-backref" href="#id3" role="doc-backlink">Bucket Logging</a><a class="headerlink" href="#bucket-logging" title="Permalink to this heading"></a></h1>
<div class="versionadded">
<p><span class="versionmodified added">New in version T.</span></p>
</div>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#bucket-logging" id="id3">Bucket Logging</a></p>
<ul>
<li><p><a class="reference internal" href="#logging-reliability" id="id4">Logging Reliability</a></p>
<ul>
<li><p><a class="reference internal" href="#standard" id="id5">Standard</a></p></li>
<li><p><a class="reference internal" href="#journal" id="id6">Journal</a></p></li>
<li><p><a class="reference internal" href="#multisite" id="id7">Multisite</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#bucket-logging-policy" id="id8">Bucket Logging Policy</a></p></li>
<li><p><a class="reference internal" href="#bucket-logging-quota" id="id9">Bucket Logging Quota</a></p></li>
<li><p><a class="reference internal" href="#bucket-logging-rest-api" id="id10">Bucket Logging REST API</a></p></li>
<li><p><a class="reference internal" href="#log-objects-key-format" id="id11">Log Objects Key Format</a></p>
<ul>
<li><p><a class="reference internal" href="#simple" id="id12">Simple</a></p></li>
<li><p><a class="reference internal" href="#partitioned" id="id13">Partitioned</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#log-records-format" id="id14">Log Records Format</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id15">Journal</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id16">Standard</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<p>Bucket logging provides a mechanism for logging all access to a bucket. The log
data can be used to monitor bucket activity, detect unauthorized access, get
insights into bucket usage, and use the logs as a journal for bucket
changes. The log records are stored in objects in a separate bucket and can be
analyzed later. Logging configuration is done at the bucket level and can be
enabled or disabled at any time. The log bucket can accumulate logs from
multiple buckets. It is recommended to configure a different “prefix” for each
bucket, so that the logs of different buckets will be stored in different
objects in the log bucket.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>The log bucket must be created before enabling logging on a bucket.</p></li>
<li><p>The log bucket cannot be the same as the bucket being logged.</p></li>
<li><p>The log bucket cannot have logging enabled on it.</p></li>
<li><p>The log bucket cannot have any encryption set on it (including SSE-S3
with AES-256).</p></li>
<li><p>The log bucket cannot have any compression set on it.</p></li>
<li><p>The log bucket must not have RequestPayer enabled.</p></li>
<li><p>Source and log buckets must be in the same zonegroup.</p></li>
<li><p>Source and log buckets may belong to different accounts (with proper
bucket policy set).</p></li>
<li><p>The log bucket may have object lock enabled with default retention period.</p></li>
<li><p>The 16-byte unique ID part of the log object name is a lexicographically
ordered random string that consists of a 10-byte counter and a 6-byte
random alphanumeric string (or a random alphanumeric string if the
counter is not available).</p></li>
</ul>
</div>
<div class="toctree-wrapper compound">
</div>
<section id="logging-reliability">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Logging Reliability</a><a class="headerlink" href="#logging-reliability" title="Permalink to this heading"></a></h2>
<p>For performance reasons, even though the log records are written to persistent
storage, the log object will appear in the log bucket only after some
configurable amount of time (or if the maximum object size of 128 MB is
reached). This time (in seconds) can be set per source bucket via a Ceph
extension to the <a class="reference internal" href="../s3/#radosgw-s3"><span class="std std-ref">REST API</span></a>, or globally via the
<code class="docutils literal notranslate"><span class="pre">rgw_bucket_logging_obj_roll_time</span></code> configuration option. If not set, the
default time is 5 minutes. Adding a log object to the log bucket is done
“lazily”, meaning that if no more records are written to the object, it may
remain outside of the log bucket even after the configured time has passed. To
counter that, you can flush all logging objects on a given source bucket to log
them, regardless if enough time passed or if no more records are written to the
object. Flushing will happen automatically when logging is disabled on a
bucket, or its logging configuration is changed, or the bucket is deleted.</p>
<p>To manually flush pending log objects to the log bucket, execute the following
command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "# ";
}
</style><span class="prompt1">radosgw-admin<span class="w"> </span>bucket<span class="w"> </span>logging<span class="w"> </span>flush<span class="w"> </span>--bucket<span class="w"> </span>&lt;<span class="nb">source</span><span class="w"> </span>bucket&gt;</span>
</pre></div></div><p>The process of adding a new log object to the log bucket is asynchronous when
triggered by a log record being written. Consequently, the operation that
generated the log is completed immediately and does not wait for the log object
addition to finish; this addition occurs later.
The log object is added to the log bucket immediately when flushed. Consequently,
this action may result in temporary gaps in the log records within the bucket
until any pending log objects are also added.</p>
<p>To check which log objects for a source bucket are currently pending addition to
the log bucket, execute the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">radosgw-admin<span class="w"> </span>bucket<span class="w"> </span>logging<span class="w"> </span>list<span class="w"> </span>--bucket<span class="w"> </span>&lt;<span class="nb">source</span><span class="w"> </span>bucket&gt;</span>
</pre></div></div><p>To view the logging configuration of a source bucket, or to see which source
buckets are logging to a specific log bucket, execute the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">radosgw-admin<span class="w"> </span>bucket<span class="w"> </span>logging<span class="w"> </span>info<span class="w"> </span>--bucket<span class="w"> </span>&lt;bucket&gt;</span>
</pre></div></div><p>When run on a source bucket, this displays the logging configuration (target
bucket, prefix, etc.). When run on a log bucket, this displays which source
buckets are sending logs to it.</p>
<section id="standard">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Standard</a><a class="headerlink" href="#standard" title="Permalink to this heading"></a></h3>
<p>If the logging type is set to “Standard” (the default) the log records are
written to the log bucket after the bucket operation is completed. This means
that the logging operation may fail with no indication to the client.</p>
</section>
<section id="journal">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Journal</a><a class="headerlink" href="#journal" title="Permalink to this heading"></a></h3>
<p>If the logging type is set to “Journal”, the records are written to the log
bucket before the bucket operation is completed. This means that if the logging
action fails, the operation is not executed and an error is returned to the
client. Some exceptions to that rule exist: the “Fails Operation” columns in
the table below indicate by “No” which operations will not fail even if logging
failed. Journal mode supports filtering out records based on matches of the
prefixes and suffixes of the logged object keys. Regular expression matching
can also be used on these to create filters. Note that it may happen that the
log records were successfully written but the bucket operation failed, since
the logs are written.</p>
<p>The following operations are supported in journal mode:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Operation</p></th>
<th class="head"><p>Operation Name</p></th>
<th class="head"><p>Fails Operation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">PutObject</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">REST.PUT.OBJECT</span></code></p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DeleteObject</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">REST.DELETE.OBJECT</span></code></p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DeleteObjects</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">REST.POST.DELETE_MULTI_OBJECT</span></code></p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">CompleteMultipartUpload</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">REST.POST.UPLOAD</span></code></p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CopyObject</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">REST.PUT.OBJECT</span></code></p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">PutObjectAcl</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">REST.PUT.ACL</span></code></p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">PutObjectLegalHold</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">REST.PUT.LEGAL_HOLD</span></code></p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">PutObjectRetention</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">REST.PUT.RETENTION</span></code></p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">PutObjectTagging</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">REST.PUT.OBJECT_TAGGING</span></code></p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DeleteObjectTagging</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">REST.DELETE.OBJECT_TAGGING</span></code></p></td>
<td><p>No</p></td>
</tr>
</tbody>
</table>
</section>
<section id="multisite">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Multisite</a><a class="headerlink" href="#multisite" title="Permalink to this heading"></a></h3>
<p>In a <a class="reference internal" href="../multisite/#multisite"><span class="std std-ref">multi-zone deployment</span></a>, each zone uses its own log object before the
log object is added to the log bucket. After the log object is added to the
log bucket (that is, after being flushed) it is replicated to other zones.
This means that for a given time period there can be more than one log object
holding relevant log records.</p>
</section>
</section>
<section id="bucket-logging-policy">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Bucket Logging Policy</a><a class="headerlink" href="#bucket-logging-policy" title="Permalink to this heading"></a></h2>
<p>Only the owner of the source bucket is allowed to enable or disable bucket
logging. For a bucket to be used as a log bucket, it must have a bucket policy
that allows that (even if the source bucket and the log bucket are owned by the
same user or account). The bucket policy must allow the <code class="docutils literal notranslate"><span class="pre">s3:PutObject</span></code> action
for the log bucket, to be performed by the <code class="docutils literal notranslate"><span class="pre">logging.s3.amazonaws.com</span></code> service
principal. The bucket policy should also specify the source bucket and account
that are expected to write logs to it. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
  <span class="s2">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;AllowLoggingFromSourceBucket&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;logging.s3.amazonaws.com&quot;</span>
      <span class="p">},</span>
      <span class="s2">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;s3:PutObject&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:s3:::log-bucket-name/prefix*&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Condition&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;StringEquals&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;aws:SourceAccount&quot;</span><span class="p">:</span> <span class="s2">&quot;source-account-id&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;ArnLike&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;aws:SourceArn&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:s3:::source-bucket-name&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="bucket-logging-quota">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Bucket Logging Quota</a><a class="headerlink" href="#bucket-logging-quota" title="Permalink to this heading"></a></h2>
<p>Bucket and user quota are applied on the log bucket. Quota is checked every
time a log record is written, and is updated when the log object is added to
the log bucket. In “Journal” mode, if the quota is exceeded, the logging
operation fails and as a result the bucket operation also fails. In “Standard”
mode, the logging operation is skipped, but the bucket operation continues.</p>
</section>
<section id="bucket-logging-rest-api">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Bucket Logging REST API</a><a class="headerlink" href="#bucket-logging-rest-api" title="Permalink to this heading"></a></h2>
<p>Detailed under: <a class="reference internal" href="../s3/bucketops/#radosgw-bucketops"><span class="std std-ref">桶操作</span></a>.</p>
</section>
<section id="log-objects-key-format">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Log Objects Key Format</a><a class="headerlink" href="#log-objects-key-format" title="Permalink to this heading"></a></h2>
<section id="simple">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Simple</a><a class="headerlink" href="#simple" title="Permalink to this heading"></a></h3>
<p>The “Simple” log objects key has the following format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">prefix</span><span class="o">&gt;&lt;</span><span class="n">year</span><span class="o">-</span><span class="n">month</span><span class="o">-</span><span class="n">day</span><span class="o">-</span><span class="n">hour</span><span class="o">-</span><span class="n">minute</span><span class="o">-</span><span class="n">second</span><span class="o">&gt;-&lt;</span><span class="mi">16</span> <span class="nb">bytes</span> <span class="n">unique</span><span class="o">-</span><span class="nb">id</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fish</span><span class="o">/</span><span class="mi">2024</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">40</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">0000000002</span><span class="n">AGQ6W1</span>
</pre></div>
</div>
</section>
<section id="partitioned">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Partitioned</a><a class="headerlink" href="#partitioned" title="Permalink to this heading"></a></h3>
<p>The “Partitioned” log objects key has the following format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">prefix</span><span class="o">&gt;&lt;</span><span class="n">source</span> <span class="n">bucket</span> <span class="n">owner</span><span class="o">&gt;/&lt;</span><span class="n">zone</span> <span class="n">group</span><span class="o">&gt;/</span><span class="p">[</span><span class="n">tenant</span><span class="p">:]</span><span class="o">&lt;</span><span class="n">source</span> <span class="n">bucket</span> <span class="n">name</span><span class="o">&gt;/&lt;</span><span class="n">year</span><span class="o">&gt;/&lt;</span><span class="n">month</span><span class="o">&gt;/&lt;</span><span class="n">day</span><span class="o">&gt;/&lt;</span><span class="n">year</span><span class="o">-</span><span class="n">month</span><span class="o">-</span><span class="n">day</span><span class="o">-</span><span class="n">hour</span><span class="o">-</span><span class="n">minute</span><span class="o">-</span><span class="n">second</span><span class="o">&gt;-&lt;</span><span class="mi">16</span> <span class="nb">bytes</span> <span class="n">unique</span><span class="o">-</span><span class="nb">id</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fish</span><span class="o">/</span><span class="n">testid</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">fish</span><span class="o">-</span><span class="n">bucket</span><span class="o">/</span><span class="mi">2024</span><span class="o">/</span><span class="mi">08</span><span class="o">/</span><span class="mi">06</span><span class="o">/</span><span class="mi">2024</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">18</span><span class="o">-</span><span class="mi">0000000011</span><span class="n">D1FGPA</span>
</pre></div>
</div>
</section>
</section>
<section id="log-records-format">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">Log Records Format</a><a class="headerlink" href="#log-records-format" title="Permalink to this heading"></a></h2>
<p>The log records are space-separated string columns and have the following
possible formats:</p>
<section id="id1">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">Journal</a><a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<p>The “Journal” record format uses minimum amount of data for journaling
bucket changes (this is a Ceph extension).</p>
<blockquote>
<div><ul class="simple">
<li><p>bucket owner (or dash if empty)</p></li>
<li><p>bucket name (or dash if empty), in the format: <code class="docutils literal notranslate"><span class="pre">[tenant:]&lt;bucket</span> <span class="pre">name&gt;</span></code></p></li>
<li><p>time in the following format: <code class="docutils literal notranslate"><span class="pre">[day/month/year:hour:minute:second</span> <span class="pre">timezone]</span></code></p></li>
<li><p>operation in the following format: <code class="docutils literal notranslate"><span class="pre">WEBSITE/REST.&lt;HTTP</span> <span class="pre">method&gt;.&lt;resource&gt;</span></code></p></li>
<li><p>object key (or dash if empty)</p></li>
<li><p>object size (or dash if empty)</p></li>
<li><p>version id (or dash if empty)</p></li>
<li><p>eTag (or dash if empty)</p></li>
</ul>
</div></blockquote>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">testid</span> <span class="n">fish</span> <span class="p">[</span><span class="mi">06</span><span class="o">/</span><span class="n">Aug</span><span class="o">/</span><span class="mi">2024</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">09</span> <span class="o">+</span><span class="mi">0000</span><span class="p">]</span> <span class="n">REST</span><span class="o">.</span><span class="n">PUT</span><span class="o">.</span><span class="n">OBJECT</span> <span class="n">myfile</span> <span class="o">-</span> <span class="mi">512</span> <span class="mi">4</span><span class="n">cfdfc1f58e762d3e116787cb92fac60</span>
<span class="n">testid</span> <span class="n">fish</span> <span class="p">[</span><span class="mi">06</span><span class="o">/</span><span class="n">Aug</span><span class="o">/</span><span class="mi">2024</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">28</span> <span class="o">+</span><span class="mi">0000</span><span class="p">]</span> <span class="n">REST</span><span class="o">.</span><span class="n">DELETE</span><span class="o">.</span><span class="n">OBJECT</span> <span class="n">myfile</span> <span class="o">-</span> <span class="o">-</span> <span class="mi">4</span><span class="n">cfdfc1f58e762d3e116787cb92fac60</span>
</pre></div>
</div>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Standard</a><a class="headerlink" href="#id2" title="Permalink to this heading"></a></h3>
<p>The “Standard” record format is based on <a class="reference external" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/LogFormat.html">AWS Logging Record Format</a>.</p>
<blockquote>
<div><ul class="simple">
<li><p>bucket owner (or dash if empty)</p></li>
<li><p>bucket name (or dash if empty) in the format: <code class="docutils literal notranslate"><span class="pre">[tenant:]&lt;bucket</span> <span class="pre">name&gt;</span></code></p></li>
<li><p>time in the following format: <code class="docutils literal notranslate"><span class="pre">[day/month/year:hour:minute:second</span> <span class="pre">timezone]</span></code> where “timezone” is in UTC offset</p></li>
<li><p>client IP address (or dash if empty)</p></li>
<li><p>user or account (or dash if empty)</p></li>
<li><p>request ID</p></li>
<li><p>operation in the following format: <code class="docutils literal notranslate"><span class="pre">WEBSITE/REST.&lt;HTTP</span> <span class="pre">method&gt;.&lt;resource&gt;</span></code></p></li>
<li><p>object key (or dash if empty)</p></li>
<li><p>request URI in the following format: <code class="docutils literal notranslate"><span class="pre">&quot;&lt;HTTP</span> <span class="pre">method&gt;</span> <span class="pre">&lt;URI&gt;</span> <span class="pre">&lt;HTTP</span> <span class="pre">version&gt;&quot;</span></code></p></li>
<li><p>HTTP status (or dash if zero). Note that in most cases log is written before the status is known</p></li>
<li><p>error code (or dash if empty)</p></li>
<li><p>bytes sent (or dash if zero)</p></li>
<li><p>object size (or dash if zero)</p></li>
<li><p>total time (not supported, always a dash)</p></li>
<li><p>turnaround time in milliseconds</p></li>
<li><p>referer (or dash if empty)</p></li>
<li><p>user agent (or dash if empty) inside double quotes</p></li>
<li><p>version id (or dash if empty)</p></li>
<li><p>host id taken from <code class="docutils literal notranslate"><span class="pre">x-amz-id-2</span></code> (or dash if empty)</p></li>
<li><p>signature version (or dash if empty)</p></li>
<li><p>cipher suite (or dash if empty)</p></li>
<li><p>authentication type (<code class="docutils literal notranslate"><span class="pre">AuthHeader</span></code> for regular auth, <code class="docutils literal notranslate"><span class="pre">QueryString</span></code> for presigned URL or dash if unauthenticated)</p></li>
<li><p>host header (or dash if empty)</p></li>
<li><p>TLS version (or dash if empty)</p></li>
<li><p>access point ARN (not supported, always a dash)</p></li>
<li><p>ACL flag (<code class="docutils literal notranslate"><span class="pre">Yes</span></code> if an ACL was required for authorization, otherwise dash)</p></li>
</ul>
</div></blockquote>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">testid</span> <span class="n">fish</span> <span class="p">[</span><span class="mi">06</span><span class="o">/</span><span class="n">Aug</span><span class="o">/</span><span class="mi">2024</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">25</span> <span class="o">+</span><span class="mi">0000</span><span class="p">]</span> <span class="o">-</span> <span class="n">testid</span> <span class="mf">9e369</span><span class="n">a15</span><span class="o">-</span><span class="mi">5</span><span class="n">f43</span><span class="o">-</span><span class="mi">4</span><span class="n">f07</span><span class="o">-</span><span class="n">b638</span><span class="o">-</span><span class="n">de920b22f91b</span><span class="mf">.4179.15085270386962380710</span> <span class="n">REST</span><span class="o">.</span><span class="n">PUT</span><span class="o">.</span><span class="n">OBJECT</span> <span class="n">myfile</span> <span class="s2">&quot;PUT /fish/myfile HTTP/1.1&quot;</span> <span class="mi">200</span> <span class="o">-</span> <span class="mi">512</span> <span class="mi">512</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="n">localhost</span> <span class="o">-</span> <span class="o">-</span>
<span class="n">testid</span> <span class="n">fish</span> <span class="p">[</span><span class="mi">06</span><span class="o">/</span><span class="n">Aug</span><span class="o">/</span><span class="mi">2024</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">51</span> <span class="o">+</span><span class="mi">0000</span><span class="p">]</span> <span class="o">-</span> <span class="n">testid</span> <span class="mf">9e369</span><span class="n">a15</span><span class="o">-</span><span class="mi">5</span><span class="n">f43</span><span class="o">-</span><span class="mi">4</span><span class="n">f07</span><span class="o">-</span><span class="n">b638</span><span class="o">-</span><span class="n">de920b22f91b</span><span class="mf">.4179.7046073853138417766</span> <span class="n">REST</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">OBJECT</span> <span class="n">myfile</span> <span class="s2">&quot;GET /fish/myfile HTTP/1.1&quot;</span> <span class="mi">200</span> <span class="o">-</span> <span class="o">-</span> <span class="mi">512</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="n">localhost</span> <span class="o">-</span> <span class="o">-</span>
<span class="n">testid</span> <span class="n">fish</span> <span class="p">[</span><span class="mi">06</span><span class="o">/</span><span class="n">Aug</span><span class="o">/</span><span class="mi">2024</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">56</span> <span class="o">+</span><span class="mi">0000</span><span class="p">]</span> <span class="o">-</span> <span class="n">testid</span> <span class="mf">9e369</span><span class="n">a15</span><span class="o">-</span><span class="mi">5</span><span class="n">f43</span><span class="o">-</span><span class="mi">4</span><span class="n">f07</span><span class="o">-</span><span class="n">b638</span><span class="o">-</span><span class="n">de920b22f91b</span><span class="mf">.4179.10723158448701085570</span> <span class="n">REST</span><span class="o">.</span><span class="n">DELETE</span><span class="o">.</span><span class="n">OBJECT</span> <span class="n">myfile</span> <span class="s2">&quot;DELETE /fish/myfile1 HTTP/1.1&quot;</span> <span class="mi">200</span> <span class="o">-</span> <span class="o">-</span> <span class="mi">512</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="o">-</span> <span class="n">localhost</span> <span class="o">-</span> <span class="o">-</span>
</pre></div>
</div>
</section>
</section>
</section>



<div id="support-the-ceph-foundation" class="admonition note">
  <p class="first admonition-title">Brought to you by the Ceph Foundation</p>
  <p class="last">The Ceph Documentation is a community resource funded and hosted by the non-profit <a href="https://ceph.io/en/foundation/">Ceph Foundation</a>. If you would like to support this and our other efforts, please consider <a href="https://ceph.io/en/foundation/join/">joining now</a>.</p>
</div>


           </div>
           
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../uadk-accel/" class="btn btn-neutral float-left" title="UADK Acceleration for Compression" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../s3_objects_dedup/" class="btn btn-neutral float-right" title="Full RGW Object Dedup" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).</p>
  </div>

   

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>