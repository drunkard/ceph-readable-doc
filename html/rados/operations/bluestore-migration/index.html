

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>迁移到 BlueStore &mdash; Ceph Documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/ceph.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
    <link rel="next" title="控制命令" href="../control/" />
    <link rel="prev" title="设备管理" href="../devices/" /> 
</head>

<body class="wy-body-for-nav">

   
  <header class="top-bar">
    <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../">Ceph 存储集群</a></li>
          <li class="breadcrumb-item"><a href="../">集群运维</a></li>
      <li class="breadcrumb-item active">迁移到 BlueStore</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/rados/operations/bluestore-migration.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
  </header>
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #eee" >
          

          
            <a href="../../../" class="icon icon-home"> Ceph
          

          
          </a>

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../start/">Ceph 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/">安装 Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cephadm/">Cephadm</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../">Ceph 存储集群</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../configuration/">配置</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../">运维</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../operating/">操纵集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="../health-checks/">健康检查</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring/">监控集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="../monitoring-osd-pg/">监控 OSD 和归置组</a></li>
<li class="toctree-l3"><a class="reference internal" href="../user-management/">用户管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pgcalc/">PG Calc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data-placement/">数据归置概览</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pools/">存储池</a></li>
<li class="toctree-l3"><a class="reference internal" href="../erasure-code/">纠删码</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cache-tiering/">分级缓存</a></li>
<li class="toctree-l3"><a class="reference internal" href="../placement-groups/">归置组</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upmap/">使用 pg-upmap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../read-balancer/">Operating the Read (Primary) Balancer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../balancer/">均衡器模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="../crush-map/">CRUSH 图</a></li>
<li class="toctree-l3"><a class="reference internal" href="../crush-map-edits/">手动编辑一个 CRUSH 图</a></li>
<li class="toctree-l3"><a class="reference internal" href="../stretch-mode/">Stretch Clusters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../change-mon-elections/">Configuring Monitor Election Strategies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../add-or-rm-osds/">增加/删除 OSD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../add-or-rm-mons/">增加/删除监视器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../devices/">设备管理</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">迁移到 BlueStore</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#bluestore-osd">用 BlueStore 部署新 OSD</a></li>
<li class="toctree-l4"><a class="reference internal" href="#osd">转换已有 OSD</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../control/">命令参考</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../troubleshooting/community/">Ceph 社区</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../troubleshooting/troubleshooting-mon/">监视器故障排除</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../troubleshooting/troubleshooting-osd/">OSD 故障排除</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../troubleshooting/troubleshooting-pg/">归置组排障</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../troubleshooting/log-and-debug/">日志记录和调试</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../troubleshooting/cpu-profiling/">CPU 剖析</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../troubleshooting/memory-profiling/">内存剖析</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../man/">    手册页</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../troubleshooting/">故障排除</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/">APIs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../cephfs/">Ceph 文件系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rbd/">Ceph 块设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../radosgw/">Ceph 对象网关</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mgr/">Ceph 管理器守护进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mgr/dashboard/">Ceph 仪表盘</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../monitoring/">监控概览</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/">API 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture/">体系结构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/developer_guide/">开发者指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/internals/">Ceph 内幕</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../governance/">项目管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../foundation/">Ceph 基金会</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../crimson/crimson/">Crimson (Tech Preview)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releases/general/">Ceph 版本（总目录）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releases/">Ceph 版本（索引）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hardware-monitoring/">硬件监控</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/">Ceph 术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jaegertracing/">Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../translation_cn/">中文版翻译资源</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../">Ceph</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
<div id="dev-warning" class="admonition note">
  <p class="first admonition-title">Notice</p>
  <p class="last">This document is for a development version of Ceph.</p>
</div>
  <div id="docubetter" align="right" style="padding: 5px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="bluestore">
<span id="rados-operations-bluestore-migration"></span><h1>迁移到 BlueStore<a class="headerlink" href="#bluestore" title="Permalink to this heading"></a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Filestore 在 Reef 版已经废弃了，且不再支持。请迁移到 BlueStore 。</p>
</div>
<p>每个 OSD 都必须格式化成 Filestore 或 BlueStore 。然而，
Ceph 集群可以同时靠 Filestore OSD 和 BlueStore OSD 的混合体运行。
由于 BlueStore 在性能和稳健性方面优于 Filestore ，并且从 Reef 版本开始，
Ceph 就不再支持 Filestore ，因此部署 Filestore OSD 的用户应迁移到 BlueStore 。
迁移到 BlueStore 有几种策略。</p>
<p>BlueStore 与 Filestore 截然不同，因此单个 OSD 无法直接转换。
相反，转换过程必须使用以下两种方法之一：
(1) 利用集群的常规复制和修复功能，或
(2) 用工具和策略将 OSD 内容从旧（ Filestore ）设备复制到新（ BlueStore ）设备。</p>
<section id="bluestore-osd">
<h2>用 BlueStore 部署新 OSD<a class="headerlink" href="#bluestore-osd" title="Permalink to this heading"></a></h2>
<p>在部署新的 OSD （例如，集群扩展时）时，要用 BlueStore 。
由于这是默认行为，所以无需任何特殊更改。</p>
<p>同样，在更换故障驱动器后，重新配置 OSD 时也要用 BlueStore 。</p>
</section>
<section id="osd">
<h2>转换已有 OSD<a class="headerlink" href="#osd" title="Permalink to this heading"></a></h2>
<section id="out">
<h3>“标记为 <code class="docutils literal notranslate"><span class="pre">out</span></code> ”的替代<a class="headerlink" href="#out" title="Permalink to this heading"></a></h3>
<p>最简单的方法是先验证集群是否正常运行，
然后依次对每个 Filestore OSD 执行以下步骤：
把这个 OSD 标记为 <code class="docutils literal notranslate"><span class="pre">out</span></code> ，等待数据在集群中复制完成，
重新配置这个 OSD ，再把这个 OSD 标记回 <code class="docutils literal notranslate"><span class="pre">in</span></code> ，
并等待恢复完成，再继续处理下一个 OSD 。这种方法易于自动化，
但会带来不必要的数据迁移，从而产生时间和 SSD 磨损方面的成本。</p>
<ol class="arabic">
<li><p>找一个要替换掉 Filestore OSD:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ID</span><span class="o">=&lt;</span><span class="n">osd</span><span class="o">-</span><span class="nb">id</span><span class="o">-</span><span class="n">number</span><span class="o">&gt;</span>
<span class="n">DEVICE</span><span class="o">=&lt;</span><span class="n">disk</span><span class="o">-</span><span class="n">device</span><span class="o">&gt;</span>
</pre></div>
</div>
<ol class="arabic">
<li><p>判断指定的 OSD 是 Filestore 还是 BlueStore ：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "$ ";
}
</style><span class="prompt1">ceph<span class="w"> </span>osd<span class="w"> </span>metadata<span class="w"> </span><span class="nv">$ID</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>osd_objectstore</span>
</pre></div></div></li>
<li><p>获取 Filestore 和 BlueStore OSD 当前的数量：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>osd<span class="w"> </span>count-metadata<span class="w"> </span>osd_objectstore</span>
</pre></div></div></li>
</ol>
</li>
<li><p>把一个 Filestore OSD 标记为 <code class="docutils literal notranslate"><span class="pre">out</span></code> ：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>osd<span class="w"> </span>out<span class="w"> </span><span class="nv">$ID</span></span>
</pre></div></div></li>
<li><p>等待数据迁移出这个 OSD ：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1"><span class="k">while</span><span class="w"> </span>!<span class="w"> </span>ceph<span class="w"> </span>osd<span class="w"> </span>safe-to-destroy<span class="w"> </span><span class="nv">$ID</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span></span>
</pre></div></div></li>
<li><p>停止 OSD ：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">systemctl<span class="w"> </span><span class="nb">kill</span><span class="w"> </span>ceph-osd@<span class="nv">$ID</span></span>
</pre></div></div></li>
<li id="osd-id-retrieval"><p>记下这个 OSD 在使用哪个设备：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">mount<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>/var/lib/ceph/osd/ceph-<span class="nv">$ID</span></span>
</pre></div></div></li>
<li><p>卸载这个 OSD ：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">umount<span class="w"> </span>/var/lib/ceph/osd/ceph-<span class="nv">$ID</span></span>
</pre></div></div></li>
<li><p>销毁 OSD 的数据。请 <em>务必小心</em>！
这些命令将销毁设备的内容；在继续操作之前，
必须确保设备上的数据不再需要（换句话说，集群状态良好）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph-volume<span class="w"> </span>lvm<span class="w"> </span>zap<span class="w"> </span><span class="nv">$DEVICE</span></span>
</pre></div></div></li>
<li><p>告诉集群这个 OSD 已经销毁了
（并且可以用同一个 OSD ID 重新部署新 OSD 了）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>osd<span class="w"> </span>destroy<span class="w"> </span><span class="nv">$ID</span><span class="w"> </span>--yes-i-really-mean-it</span>
</pre></div></div></li>
<li><p>用同一个 OSD ID 在原地部署 BlueStore OSD 。
这就要求你根据 <a class="reference internal" href="#osd-id-retrieval"><span class="std std-ref">“注意 OSD 正在使用的设备”</span></a>
这一步骤中检索到的信息，确定要擦除的设备、
并确保目标设备是正确且预期的设备。
<strong>务必小心！</strong> 注意，在操作混合式 OSD 时，
你可能需要修改这些命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph-volume<span class="w"> </span>lvm<span class="w"> </span>create<span class="w"> </span>--bluestore<span class="w"> </span>--data<span class="w"> </span><span class="nv">$DEVICE</span><span class="w"> </span>--osd-id<span class="w"> </span><span class="nv">$ID</span></span>
</pre></div></div></li>
<li><p>如此往复。</p></li>
</ol>
<p>您可以选择 (1) 在替换 BlueStore OSD 的同时，对下一个 Filestore OSD 进行数据迁移，
或者 (2) 并行地对多个 OSD 执行相同的操作。但无论哪种情况，在销毁任何 OSD 之前，
必须确保集群完全一致（即所有数据都复制够了所有副本）。
如果你选择并行地重新配置多个 OSD ，<strong>务必小心</strong>，
只能销毁单个 CRUSH 故障域（例如 <code class="docutils literal notranslate"><span class="pre">host</span></code> 或 <code class="docutils literal notranslate"><span class="pre">rack</span></code> ）内的 OSD 。
如果不满足此要求，将降低数据的冗余性和可用性，
而且增加了数据丢失的风险（甚至导致数据丢失）。</p>
<p>优点：</p>
<ul class="simple">
<li><p>简单。</p></li>
<li><p>可以按设备逐个地完成。</p></li>
<li><p>不需要备用设备或主机。</p></li>
</ul>
<p>缺点：</p>
<ul class="simple">
<li><p>数据通过网络复制两次：一次是复制到集群中的另一个 OSD
（以维持指定的副本数），另一次是复制回重新配置过的 BlueStore OSD 。</p></li>
</ul>
</section>
<section id="id1">
<h3>“整机”替换<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<p>如果集群中有备用主机，或者有足够的空闲空间来腾出一整台主机作为备用，
那么就可以逐台主机进行转换，这样存储的每个数据副本只需迁移一次。</p>
<p>要用这种方法，你需要一台没配置过 OSD 的空主机。有两种方法可以实现：
一是使用全新的、尚未加入集群的空主机，二是从已加入集群的现有主机上卸载数据。</p>
<section id="id2">
<h4>利用新的、空主机<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h4>
<p>理想情况下，一台主机的容量应该与将要转换的其他每台主机的容量差不多。
把这台主机加进 CRUSH 分级结构中，但不要把它绑到 root 节点：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1"><span class="nv">NEWHOST</span><span class="o">=</span>&lt;empty-host-name&gt;</span>
<span class="prompt1">ceph<span class="w"> </span>osd<span class="w"> </span>crush<span class="w"> </span>add-bucket<span class="w"> </span><span class="nv">$NEWHOST</span><span class="w"> </span>host</span>
</pre></div></div><p>确保在新主机上安装了 Ceph 软件包。</p>
</section>
<section id="id3">
<h4>利用已有主机<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h4>
<p>如果你想用已经是集群一部分的现有主机，并且该主机上有足够的空闲空间，
足以将所有数据迁移到集群内的其他主机上，
那么您可以采用以下步骤（而不是用新的空主机）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1"><span class="nv">OLDHOST</span><span class="o">=</span>&lt;existing-cluster-host-to-offload&gt;</span>
<span class="prompt1">ceph<span class="w"> </span>osd<span class="w"> </span>crush<span class="w"> </span>unlink<span class="w"> </span><span class="nv">$OLDHOST</span><span class="w"> </span>default</span>
</pre></div></div><p>其中， “default” 是 CRUSH 图中的直接父节点。
（对于配置未修改的小型集群，这通常为 “default” ，
但也可能是一个机架名。）现在，
您应该会在 OSD 树输出的顶部看到该主机，而且它没有父节点：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">bin/ceph<span class="w"> </span>osd<span class="w"> </span>tree</span>
</pre></div></div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ID</span> <span class="n">CLASS</span> <span class="n">WEIGHT</span>  <span class="n">TYPE</span> <span class="n">NAME</span>     <span class="n">STATUS</span> <span class="n">REWEIGHT</span> <span class="n">PRI</span><span class="o">-</span><span class="n">AFF</span>
<span class="o">-</span><span class="mi">5</span>             <span class="mi">0</span> <span class="n">host</span> <span class="n">oldhost</span>
<span class="mi">10</span>   <span class="n">ssd</span> <span class="mf">1.00000</span>     <span class="n">osd</span><span class="mf">.10</span>        <span class="n">up</span>  <span class="mf">1.00000</span> <span class="mf">1.00000</span>
<span class="mi">11</span>   <span class="n">ssd</span> <span class="mf">1.00000</span>     <span class="n">osd</span><span class="mf">.11</span>        <span class="n">up</span>  <span class="mf">1.00000</span> <span class="mf">1.00000</span>
<span class="mi">12</span>   <span class="n">ssd</span> <span class="mf">1.00000</span>     <span class="n">osd</span><span class="mf">.12</span>        <span class="n">up</span>  <span class="mf">1.00000</span> <span class="mf">1.00000</span>
<span class="o">-</span><span class="mi">1</span>       <span class="mf">3.00000</span> <span class="n">root</span> <span class="n">default</span>
<span class="o">-</span><span class="mi">2</span>       <span class="mf">3.00000</span>     <span class="n">host</span> <span class="n">foo</span>
 <span class="mi">0</span>   <span class="n">ssd</span> <span class="mf">1.00000</span>         <span class="n">osd</span><span class="mf">.0</span>     <span class="n">up</span>  <span class="mf">1.00000</span> <span class="mf">1.00000</span>
 <span class="mi">1</span>   <span class="n">ssd</span> <span class="mf">1.00000</span>         <span class="n">osd</span><span class="mf">.1</span>     <span class="n">up</span>  <span class="mf">1.00000</span> <span class="mf">1.00000</span>
 <span class="mi">2</span>   <span class="n">ssd</span> <span class="mf">1.00000</span>         <span class="n">osd</span><span class="mf">.2</span>     <span class="n">up</span>  <span class="mf">1.00000</span> <span class="mf">1.00000</span>
<span class="o">...</span>
</pre></div>
</div>
<p>如果一切安好，直接跳到下面 <a class="reference internal" href="#bluestore-data-migration-step"><span class="std std-ref">“等待数据迁移完成”</span></a> 这个步骤，然后从那里开始清理旧 OSD 。</p>
</section>
<section id="id4">
<h4>迁移过程<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h4>
<p>如果你用的是新主机，从 <a class="reference internal" href="#bluestore-migration-process-first-step"><span class="std std-ref">第一步</span></a>
开始；如果你用的是现有主机，跳转到
<a class="reference internal" href="#bluestore-data-migration-step"><span class="std std-ref">这一步</span></a> 。</p>
<ol class="arabic" id="bluestore-migration-process-first-step">
<li><p>在所有设备上配置新的 BlueStore OSD ：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph-volume<span class="w"> </span>lvm<span class="w"> </span>create<span class="w"> </span>--bluestore<span class="w"> </span>--data<span class="w"> </span>/dev/<span class="nv">$DEVICE</span></span>
</pre></div></div></li>
<li><p>核对一下这个 OSD 已加入集群：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>osd<span class="w"> </span>tree</span>
</pre></div></div><p>你应该能看到这个新主机 <code class="docutils literal notranslate"><span class="pre">$NEWHOST</span></code> ，它下面还挂着所有的
OSD ，但是这台主机<em>不应该</em>嵌入分级结构的其它任何节点（像 <code class="docutils literal notranslate"><span class="pre">root</span> <span class="pre">default</span></code> ）。例如，假设 <code class="docutils literal notranslate"><span class="pre">newhost</span></code> 就是这台空主机，你可能看到类似的：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ bin/ceph osd tree
ID CLASS WEIGHT  TYPE NAME     STATUS REWEIGHT PRI-AFF
-5             0 host newhost
10   ssd 1.00000     osd.10        up  1.00000 1.00000
11   ssd 1.00000     osd.11        up  1.00000 1.00000
12   ssd 1.00000     osd.12        up  1.00000 1.00000
-1       3.00000 root default
-2       3.00000     host oldhost1
 0   ssd 1.00000         osd.0     up  1.00000 1.00000
 1   ssd 1.00000         osd.1     up  1.00000 1.00000
 2   ssd 1.00000         osd.2     up  1.00000 1.00000
...
</pre></div>
</div>
</li>
<li><p>找出第一台要转换的主机：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1"><span class="nv">OLDHOST</span><span class="o">=</span>&lt;existing-cluster-host-to-convert&gt;</span>
</pre></div></div></li>
<li><p>交换集群里新旧主机的位置：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>osd<span class="w"> </span>crush<span class="w"> </span>swap-bucket<span class="w"> </span><span class="nv">$NEWHOST</span><span class="w"> </span><span class="nv">$OLDHOST</span></span>
</pre></div></div><p>此时， <code class="docutils literal notranslate"><span class="pre">$OLDHOST</span></code> 上的所有数据将开始迁移到 <code class="docutils literal notranslate"><span class="pre">$NEWHOST</span></code> 上的 OSD 。
如果旧主机的总容量与新主机的总容量有差异，
您可能还会看到一些数据迁移到集群中的其他节点，
或从其他节点迁移出来。然而，
如果主机的大小相似，那么迁移的数据量将相对较少。</p>
</li>
<li id="bluestore-data-migration-step"><p>等待数据迁移完成：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1"><span class="k">while</span><span class="w"> </span>!<span class="w"> </span>ceph<span class="w"> </span>osd<span class="w"> </span>safe-to-destroy<span class="w"> </span><span class="k">$(</span>ceph<span class="w"> </span>osd<span class="w"> </span>ls-tree<span class="w"> </span><span class="nv">$OLDHOST</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">60</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">done</span></span>
</pre></div></div></li>
<li><p>现在 <code class="docutils literal notranslate"><span class="pre">$OLDHOST</span></code> 主机空了，停止其上的所有旧 OSD ：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ssh<span class="w"> </span><span class="nv">$OLDHOST</span></span>
<span class="prompt1">systemctl<span class="w"> </span><span class="nb">kill</span><span class="w"> </span>ceph-osd.target</span>
<span class="prompt1">umount<span class="w"> </span>/var/lib/ceph/osd/ceph-*</span>
</pre></div></div></li>
<li><p>销毁并擦除旧的 OSD ：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1"><span class="k">for</span><span class="w"> </span>osd<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="sb">`</span>ceph<span class="w"> </span>osd<span class="w"> </span>ls-tree<span class="w"> </span><span class="nv">$OLDHOST</span><span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="k">do</span></span>
<span class="prompt1"><span class="w">   </span>ceph<span class="w"> </span>osd<span class="w"> </span>purge<span class="w"> </span><span class="nv">$osd</span><span class="w"> </span>--yes-i-really-mean-it</span>
<span class="prompt1"><span class="k">done</span></span>
</pre></div></div></li>
<li><p>擦除旧的 OSD 。你得手动找出要擦除的设备。
<strong>谨慎！</strong> 在每个设备上：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph-volume<span class="w"> </span>lvm<span class="w"> </span>zap<span class="w"> </span><span class="nv">$DEVICE</span></span>
</pre></div></div></li>
<li><p>把当前为空的主机作为新主机，重复：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1"><span class="nv">NEWHOST</span><span class="o">=</span><span class="nv">$OLDHOST</span></span>
</pre></div></div></li>
</ol>
<p>优点：</p>
<ul class="simple">
<li><p>数据通过网络只复制一次。</p></li>
<li><p>整台主机上的 OSD 一次就能转换完毕。</p></li>
<li><p>可以并行化，有可能实现多台主机同时转换。</p></li>
<li><p>此过程中涉及的所有主机都不需要备用设备。</p></li>
</ul>
<p>缺点：</p>
<ul class="simple">
<li><p>需要一台备用主机。</p></li>
<li><p>整台主机上健在的 OSD 将会同时迁移数据。
这很可能影响整个集群的性能。</p></li>
<li><p>所有迁移的数据仍然需要通过网络完整地进行一次传输。</p></li>
</ul>
</section>
</section>
<section id="id5">
<h3>逐个 OSD 设备进行复制<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h3>
<p>单个逻辑 OSD 可以用 <code class="docutils literal notranslate"><span class="pre">ceph-objectstore-tool</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">copy</span></code> 功能来转换。
这要求主机有一或多个空闲设备来配置一个新的、空的 BlueStore OSD 。
例如，如果集群中的每个主机有 12 个 OSD ，那么你需要第 13 个未使用的 OSD ，
这样就能在回收前一个 OSD 之后逐个转换下一个 OSD 。</p>
<p>注意事项：</p>
<ul class="simple">
<li><p>此方法要求我们准备一个空的 BlueStore OSD ，但不给它分配新 OSD ID 。
<code class="docutils literal notranslate"><span class="pre">ceph-volume</span></code> 工具不支持这样的操作。 <strong>重要提示</strong>：
由于 <em>dmcrypt</em> 的配置与 OSD 的身份识别紧密相关，
因此这种方法不适用于加密 OSD 。</p></li>
<li><p>这个设备必须手动分区。</p></li>
<li><p>有个无支持的、用户贡献的脚本，演示了这个过程，脚本在这里：
<a class="reference external" href="https://github.com/ceph/ceph/blob/master/src/script/contrib/ceph-migrate-bluestore.bash">https://github.com/ceph/ceph/blob/master/src/script/contrib/ceph-migrate-bluestore.bash</a></p></li>
</ul>
<p>优点：</p>
<ul class="simple">
<li><p>转换期间，只要 OSD 或集群上设置了
<cite>noout</cite> 或者 <cite>norecover</cite>/<cite>norebalance</cite>  标记，
就只会有少量或没有数据通过网络迁移。</p></li>
</ul>
<p>缺点：</p>
<ul class="simple">
<li><p>工具链尚未完全实现、支持、或有文档；</p></li>
<li><p>每台主机必须有一个合适的备用或空闲设备，用于腾挪。</p></li>
<li><p>在转换期间， OSD 处于离线状态，这意味着在目标 OSD 启动并恢复之前，对 acting set 中包含这个 OSD 的 PG 的新写入可能不会实现预期的冗余度。
这会增加由于重叠故障而导致数据丢失的风险。
然而，如果在转换和启动完成之前另一个 OSD 发生故障，
还可以启动原先的 Filestore OSD 以访问其原始数据。</p></li>
</ul>
</section>
</section>
</section>



<div id="support-the-ceph-foundation" class="admonition note">
  <p class="first admonition-title">Brought to you by the Ceph Foundation</p>
  <p class="last">The Ceph Documentation is a community resource funded and hosted by the non-profit <a href="https://ceph.io/en/foundation/">Ceph Foundation</a>. If you would like to support this and our other efforts, please consider <a href="https://ceph.io/en/foundation/join/">joining now</a>.</p>
</div>


           </div>
           
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../devices/" class="btn btn-neutral float-left" title="设备管理" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../control/" class="btn btn-neutral float-right" title="控制命令" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).</p>
  </div>

   

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>